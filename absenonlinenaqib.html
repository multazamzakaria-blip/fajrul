<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kedisiplinan Santri  Absensi & Rekap Pelanggaran</title>
<style>
  body{font-family:Arial, sans-serif;padding:18px;background:#f7f7f7}
  h1,h2{margin-top:0}
  .card{background:#fff;border:1px solid #e6e6e6;padding:18px;border-radius:10px;
        margin-bottom:18px;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
  .hidden{display:none}
  label{display:inline-block;margin:6px 0;font-weight:bold}
  input,select,textarea{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .btn{padding:10px 16px;background:#1e88e5;color:#fff;border:none;border-radius:6px;
       cursor:pointer;margin-right:8px;font-size:1rem}
  .btn.alt{background:#43a047}
  .btn.warn{background:#f57c00}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:0.95rem;background:#fff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:180px}
  .note{background:#fffbe6;border:1px solid #ffe58f;padding:10px;border-radius:6px;margin-top:12px}
  hr.sep{border:none;border-top:1px solid #eee;margin:12px 0}
  .small{font-size:0.85rem;color:#666}
  @media(max-width:900px){ .row{flex-direction:column} table{font-size:0.8rem} }
  .kpi-pass{color:green;font-weight:bold}
  .kpi-fail{color:red;font-weight:bold}
</style>
</head>
<body>
<h1>Kedisiplinan Santri</h1>
<p>Absensi Online dan Rekap Pelanggaran</p>

<!-- LOGIN -->
<div class="card" id="loginPage">
  <h3>Login Naqib / Admin</h3>
  <label>Pilih User:</label>
  <select id="userSelect"><option value="">-- Pilih User --</option></select>
  <label>Kode Akses:</label>
  <input type="password" id="kode">
  <br><br>
  <button class="btn" onclick="login()">Masuk</button>
  <p style="color:#666;margin-top:10px">Isi dengan teliti dan jujur!</p>
</div>

<!-- NAQIB DASHBOARD -->
<div class="card hidden" id="naqibDashboard">
  <h3 id="naqibLabel">Naqib</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <div>
      <button class="btn" onclick="showSection('absensiPage')">Absensi Program Harian</button>
      <button class="btn alt" onclick="showSection('pelanggaranPage')">Form Pelanggaran Santri</button>
    </div>
    <div style="margin-left:auto">
      <button class="btn warn" onclick="logout()">Logout</button>
    </div>
  </div>
</div>

<!-- ABSENSI -->
<div class="card hidden" id="absensiPage">
  <h3>Form Absensi  <span id="naqibLabel2"></span></h3>
  <div class="row">
    <div class="col">
      <label>Tanggal:</label>
      <input type="date" id="tanggal">
    </div>
    <div class="col">
      <label>Program:</label>
      <select id="program">
        <option>TAHAJJUD</option><option>SHALAT SUBUH</option><option>JOGING PAGI</option>
        <option>SHALAT ZUHUR</option><option>TIDUR SIANG</option><option>SHALAT ASHAR</option>
        <option>SHALAT MAGHRIB</option><option>SHALAT ISYA</option><option>TIDUR MALAM</option>
        <option>PIKET KEBERSIHAN</option>
      </select>
    </div>
  </div>
  <h4>Daftar Santri</h4>
  <button class="btn" onclick="checkAll()">Hadir Semua</button>
  <table>
    <thead><tr><th>Nama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th></tr></thead>
    <tbody id="santriTable"></tbody>
  </table>
  <br>
  <button class="btn alt" onclick="simpan()">Simpan Absensi</button>
  <button class="btn" style="background:#999" onclick="showSection('naqibDashboard')">Kembali</button>
</div>

<!-- PELANGGARAN -->
<div class="card hidden" id="pelanggaranPage">
  <h3>Form Pelanggaran Santri</h3>
  <div class="row">
    <div class="col">
      <label>Naqib:</label>
      <input type="text" id="pelNaqib" readonly style="background:#eee">
    </div>
    <div class="col">
      <label>Nama Santri:</label>
      <select id="pelSantri"><option value="">-- Pilih Santri --</option></select>
    </div>
    <div class="col">
      <label>Tanggal:</label>
      <input type="date" id="pelTanggal">
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div class="col">
      <label>Kategori:</label>
      <select id="pelKategori"><option value="Baru">Baru</option><option value="Berulang">Berulang</option></select>
    </div>
    <div class="col">
      <label>Jenis Pelanggaran:</label>
      <input type="text" id="pelJenis" placeholder="Contoh: Tidak Shalat, Ribut, dll">
    </div>
    <div class="col">
      <label>Level:</label>
      <select id="pelLevel"><option>Ringan</option><option>Sedang</option><option>Berat</option></select>
    </div>
  </div>
  <label style="margin-top:10px">Catatan:</label>
  <textarea id="pelCatatan" rows="3"></textarea>
  <br>
  <button class="btn alt" onclick="simpanPelanggaran()">Simpan Pelanggaran</button>
  <button class="btn" style="background:#999" onclick="showSection('naqibDashboard')">Kembali</button>
  <p class="note">Warning: Isi <b>sedatail-detailnya jenis pelanggaran dan tindakan yang Naqib lakukan pada kolom catatan,</b> cek kembali sebelum disimpan.</p>
</div>

<!-- ADMIN -->
<div class="card hidden" id="adminPage">
  <h3>Rekap Kedisiplinan Santri (Admin)</h3>

  <!-- Tombol baru paling atas: Laporan Bulanan Per Santri -->
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
    <div>
      <button class="btn" style="background:#00897b" onclick="showSection('lapBulananPage')">Laporan Bulanan Per Santri</button>
    </div>
    <div style="margin-left:auto">
      <button class="btn" onclick="rekapHarian()">Rekap Harian</button>
      <button class="btn" onclick="rekapPekanan()">Rekap Pekanan</button>
      <button class="btn" onclick="rekapBulanan()">Rekap Bulanan</button>
      <button class="btn alt" onclick="tampilkanRekap()">Tampilkan Semua</button>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>Dari:</label><input type="date" id="fromDate">
    </div>
    <div class="col">
      <label>Sampai:</label><input type="date" id="toDate">
    </div>
    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="adminNaqib"><option value="">Semua</option></select>
    </div>
    <div class="col">
      <label>Program:</label>
      <select id="filterProgram"><option value="">Semua</option><option>TAHAJJUD</option><option>SHALAT SUBUH</option><option>JOGING PAGI</option><option>SHALAT ZUHUR</option><option>TIDUR SIANG</option><option>SHALAT ASHAR</option><option>SHALAT MAGHRIB</option><option>SHALAT ISYA</option><option>TIDUR MALAM</option><option>PIKET KEBERSIHAN</option></select>
    </div>
  </div>

  <br>
  <button class="btn" style="background:#6a1b9a" onclick="rekapPelanggaranAll()">Rekap Pelanggaran</button>
  <button class="btn" style="background:#c2185b" onclick="rekapPelanggaranBaru()">Pelanggaran Baru</button>
  <button class="btn" style="background:#d81b60" onclick="rekapPelanggaranBerulang()">Pelanggaran Berulang</button>
  <button class="btn" style="background:#ff9800" onclick="cekKPI()">CEK KPI NAQIB</button>
  <button class="btn" style="background:#d32f2f;color:white" onclick="hapusSemuaPelanggaran()">Hapus Semua Pelanggaran</button>
  <button class="btn" style="background:#999" onclick="logout()">Logout</button>

  <hr class="sep">
  <h4 style="margin-top:12px">Hasil Rekap:</h4>
  <div id="rekapArea" style="min-height:200px">Silakan pilih rentang tanggal.</div>
</div>

<!-- LAPORAN BULANAN PER SANTRI -->
<div class="card hidden" id="lapBulananPage">
  <h3>Laporan Bulanan Per Santri</h3>
  <div class="row">
    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="bulananNaqib"><option value="">-- Pilih Naqib --</option></select>
    </div>
    <div class="col">
      <label>Pilih Santri:</label>
      <select id="bulananSantri"><option value="">-- Pilih Santri --</option></select>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <label>Bulan:</label>
      <select id="bulananBulan">
        <option value="">-- Pilih Bulan --</option>
        <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option><option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option><option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option><option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
      </select>
    </div>
    <div class="col">
      <label>Tahun:</label>
      <input type="number" id="bulananTahun" min="2020" max="2099" value="2025">
    </div>
  </div>
  <br>
  <button class="btn alt" onclick="generateLaporanBulanan()">Tampilkan</button>
  <button class="btn" style="background:#795548" onclick="exportLaporanBulananPDF()">Export PDF</button>
  <button class="btn" style="background:#999" onclick="showSection('adminPage')">Kembali</button>

  <h3 style="margin-top:20px">Hasil Laporan:</h3>
  <div id="lapBulananHasil"></div>
</div>

<script>
// -------------------- DATA USERS & SANTRI --------------------
const users = [
  { id: 'Admin', label: 'Admin', role: 'admin', code: 'ADMIN123' },
  { id: 'Regen', label: 'Naqib Regen', role: 'naqib', code: 'REGEN111', naqibName:'Regen' },
  { id: 'Kamal', label: 'Naqib Kamal', role: 'naqib', code: 'KAMAL111', naqibName:'Kamal' },
  { id: 'Favian', label: 'Naqib Favian', role: 'naqib', code: 'FAVIAN111', naqibName:'Favian' },
  { id: 'Dimas', label: 'Naqib Dimas', role: 'naqib', code: 'DIMAS111', naqibName:'Dimas' },
  { id: 'Shafwan', label: 'Naqib Shafwan', role: 'naqib', code: 'SHAFWAN111', naqibName:'Shafwan' },
  { id: 'Fatimah', label: 'Naqibah Fatimah', role: 'naqib', code: 'FATIMAH111', naqibName:'Fatimah' },
  { id: 'Evita', label: 'Naqibah Evita', role: 'naqib', code: 'EVITA111', naqibName:'Evita' }
];

const dataSantri = {
  "Regen":[ "AHMAD MAULANA","JUANDA NUR ILHAM","NAJMIHADI SYAUQII TAMAAM","NIZAM KABISAT","MOHAMMAD IKHSAN HAIRULI","REYFAS RAMADHAN","EZA FEBRI AL FADZRI","HAFIDZ AL ROZI","ANDES AFENDRA","FEBRI GHALIH AL FAROBI","DANANG PRASDITYA SANTOSO","MUHAMMAD RAID MAHRUS","MUHAMMAD DIRGATAMA","CANZA RYANDA HUTASUHUT","FALIZH DAFFA QATRUNNADA","DAFFA AL MUSYARI","RAFI RAMADHAN","WAHYU REYDINATA","AKBAR PRAYOGA","VERY SYACH","MUHAMMAD AL FALAH"],
  "Kamal":[ "ADITYA PUTRA IBRAHIM","AIRLANGGA AZKA ABQORI","AQIELA MARSYAH","BRILLY HANDRIAN","DARREN ATHAYA","DZIKRI MUDHOFFAR","ELLENO QUTHBIE HERMAWAN","FADIL NURHALIM","GABRIEL AL FATIH","HADINATA SAPUTRA","MIKO VAJAR","MUHAMMAD ALMISKY PRATAMA","MUHAMMAD AQIL RIDHO","MUHAMMAD IZAM SAPUTRA","MUHAMMAD SYAKIR HUTABARAT","MUHAMMAD ZIYAD ZHAZHA","MUHAMMAD YASIR AL FAZAR JHIRA","RAFA"],
  "Favian":[ "ANGGA PRATAMA PUTRA","PRAWIRO PUJO TUNGGAL JATI","MUHAMMAD MARPIN","MARFEL SAPUTRA","MELDI NOVRIANSYAH","FAUZAN IBNI JABAR","MUHAMMAD FADHIL BUANA","QHEIZAN ALQIZA ARISDA","REZFY FAKHRYAZKA","MIKA RAHEL YUSUF","KI AGUS MUHAMMAD ABDULLAH SHIDDIQ AGTSALI","ARYA DIFA ALSYA","REYNALDI MALIK IBRAHIM ALFARIDZI","MUHAMMAD XAVI NF","MUHAMMAD FAISAL FIKRIANSYAH","HAFIDZ ALRIZKY","NAUFAL AKBAR ALKHATIRI","FARAZH SAYYID PUTRA KENEGA","SYAHRUL RAMADHAN","LUTHFAN ADZAKI","MUHAMMAD ABIL IRWANSYAH","ALIF SAMUDRA","FAHRIE OKTAVIRANO FITRIS"],
  "Dimas":[ "GHOZY FATURRAHMAN","MUHAMMAD THOORIQ","AHMAD RIYADI","ALIF MUHAMMAD YUSUF","BASRI AL HAZIQ ZULFAHMI","MUHAMMAD FAQIH HAFIDZALLAH","ABDULLAH MUKTI HAFIDZALLAH","DEDI SETIADI","FAKHRI AL MUZAKKI","ILHAM MUKMIN AL FARABI","MUHAMMAD ALLAM NUR HUSAIN","MUHAMMAD FIRAAS AL INSYIROH","NABIL NAJMI","SATRIO ABIMAYU","TEGAR HIDAYAT","WAFII FADHLURROHMAN","MUHAMMAD RIJALUL KAMIL","ALVIN HERFIANTINO","ZAHIR ZIBRAN","RADEN AZAA PANCA PUTRA"],
  "Shafwan":[ "AHMAD FARHAAN","ANUGRAH PRATAMA","CAHYIS ISZAM","DIKKI KURNIAWAN","FAHRY AKBAR RAMDHANI","HABIB RAMADHAN","IHZA TRINANDI","ILHAM","M.ARYA MAHDI WAFI EL-FAUZANI","MAHESA AULIA GIFFARI","MUHAMAD YUSUF ARROSIYD","MUHAMMAD RAYYAN HAFIZ","MUHAMMAD USAMAH","NAFIS","RAKA SEPTIAN","RENAL MARTIN","ROHADIN FIRDAUS AL QAUSAR","ROID AFDAL","ZULFAKIH HAERUNNASIHIN"],
  "Fatimah":[ "NILAM CAHYA","QELZA RAMADHANI ATH THAHIRAH","ASHIFA FITRI RAMADHONI","ADIBA AILA KHANZA","AISYAH NUR KHALIFAH","NYAYU MARLITSA ARDHANI","WILDA","WINDY WINDARI","ALFERA DESTIA","AISYAH NURUL AULIA","NESSYA RAMADHANY","AMIRAH BALQIS RAHADATUL A'ISYAH","EARLYTA ARSYFA SALSABILA","DAFIA NAFLA SYAKIRA","ANISYA SEPTIANI"],
  "Evita":[ "BILQIS NUR ANISAH","JESSICA PUTRY AYRA","GHENIS ANDIENTIAZ","DINA RUHAYAH","MALWA SHAGIRAH","PITRI RAMADANI","GRINNETA NALANI PUTRI","INAYAH NOURAH ANINDYA","SHELENA","FITRAH KIRANA"]
};

let currentUser = null;

// INIT
function init(){
  const sel = document.getElementById('userSelect'); sel.innerHTML = '<option value="">-- Pilih User --</option>';
  users.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.label; sel.appendChild(o); });

  const adminSel = document.getElementById('adminNaqib');
  if(adminSel){ adminSel.innerHTML = '<option value="">Semua</option>'; Object.keys(dataSantri).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; adminSel.appendChild(o); }); }

  // populate bulananNaqib & bulananSantri
  const bn = document.getElementById('bulananNaqib'); 
bn.innerHTML='<option value="">-- Pilih Naqib --</option>';
Object.keys(dataSantri).forEach(k=>{
  const o=document.createElement('option'); 
  o.value = k;
  o.textContent = k;
  bn.appendChild(o); 
});

  // also populate bulananSantri default and admin filterProgram already has entries
  const today = new Date(); const ymd = toISODate(today); const from = new Date(); from.setDate(today.getDate()-7);
  if(document.getElementById('tanggal')) document.getElementById('tanggal').value = ymd;
  if(document.getElementById('pelTanggal')) document.getElementById('pelTanggal').value = ymd;
  if(document.getElementById('fromDate')) document.getElementById('fromDate').value = toISODate(from);
  if(document.getElementById('toDate')) document.getElementById('toDate').value = ymd;
  if(document.getElementById('bulananTahun')) document.getElementById('bulananTahun').value = today.getFullYear();
}
window.addEventListener('DOMContentLoaded', init);

// NAV
function showSection(id){ const list=['loginPage','naqibDashboard','absensiPage','pelanggaranPage','adminPage','lapBulananPage']; list.forEach(sec=>{ const el=document.getElementById(sec); if(!el) return; if(sec===id) el.classList.remove('hidden'); else el.classList.add('hidden'); }); }

// LOGIN
function login(){
  const userId = document.getElementById('userSelect').value;
  const kode = document.getElementById('kode').value.trim();
  if(!userId) return alert('Pilih user.');
  const user = users.find(u=>u.id===userId);
  if(!user) return alert('User tidak ditemukan.');
  if(kode !== user.code) return alert('Kode akses salah.');
  currentUser = user;
  document.getElementById('kode').value = '';
  document.getElementById('loginPage').classList.add('hidden');
  if(user.role === 'admin'){ showSection('adminPage'); }
  else {
    document.getElementById('naqibLabel').textContent = user.label;
    document.getElementById('naqibLabel2').textContent = user.label;
    populateSantriSelect(user.naqibName);
    openNaqibPage(user);
    showSection('absensiPage');
  }
}

// LOGOUT
function logout(){ currentUser=null; document.getElementById('userSelect').value=''; document.getElementById('kode').value=''; document.getElementById('rekapArea').innerHTML='Silakan pilih rentang tanggal.'; showSection('loginPage'); }

// ABSENSI
function openNaqibPage(user){
  const list = dataSantri[user.naqibName] || [];
  const body = document.getElementById('santriTable'); body.innerHTML = '';
  list.forEach(n=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${n}</td>
      <td><input type="radio" name="${escapeName(n)}" value="Hadir" checked></td>
      <td><input type="radio" name="${escapeName(n)}" value="Izin"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Sakit"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Alfa"></td>`;
    body.appendChild(tr);
  });
  // set pelNaqib label when opening pelanggaran page
  const pelNaqib = document.getElementById('pelNaqib');
  if(pelNaqib) pelNaqib.value = user.naqibName || '';
}
function escapeName(n){ return n.replace(/[^a-z0-9]/gi,'_'); }
function checkAll(){ document.querySelectorAll('input[value="Hadir"]').forEach(r=>r.checked=true); }

function simpan(){
  if(!currentUser || currentUser.role !== 'naqib') return alert('Hanya naqib dapat mengisi absensi.');
  const tanggal = document.getElementById('tanggal').value;
  const program = document.getElementById('program').value;
  const naqib = currentUser.naqibName;
  const rows = document.querySelectorAll('#santriTable tr');
  rows.forEach(row=>{
    const nama = row.children[0].innerText;
    const status = document.querySelector(`input[name="${escapeName(nama)}"]:checked`).value;
    if(typeof simpanOnline === 'function'){
      simpanOnline({ tanggal, program, naqib, nama, status });
    }
  });
  alert('Absensi tersimpan.');
}

// PELANGGARAN
function populateSantriSelect(naqib){
  const el = document.getElementById('pelSantri'); el.innerHTML = '<option value="">-- Pilih Santri --</option>';
  (dataSantri[naqib] || []).forEach(s=>{ const o=document.createElement('option'); o.textContent=s; o.value=s; el.appendChild(o); });
}
function simpanPelanggaran(){
  if(!currentUser) return alert('Anda belum login.');
  const naqib = currentUser.naqibName;
  const nama = document.getElementById('pelSantri').value;
  const tanggal = document.getElementById('pelTanggal').value;
  const kategori = document.getElementById('pelKategori').value;
  const jenis = document.getElementById('pelJenis').value.trim();
  const level = document.getElementById('pelLevel').value;
  const catatan = document.getElementById('pelCatatan').value;
  if(!nama) return alert('Pilih nama.'); if(!jenis) return alert('Isi jenis pelanggaran.');
  loadAllPelanggaran(list=>{
    const dup = list.find(p => p.nama === nama && p.jenis === jenis && p.tanggal === tanggal);
    if(dup) return alert('Duplikasi: Pelanggaran sudah tercatat pada tanggal itu.');
    simpanPelanggaranOnline({ tanggal, naqib, nama, kategori, jenis, level, catatan });
    alert('Pelanggaran disimpan.');
    document.getElementById('pelJenis').value=''; document.getElementById('pelCatatan').value='';
  });
}

// REKAP utama (tabel per program x naqib)
function rekapHarian(){
  // use current fromDate & toDate
  loadFilteredRange(list=>{
    renderRekapTable(list, 'Rekap Harian');
  });
}
function rekapPekanan(){
  // set fromDate to 6 days before toDate
  const toEl = document.getElementById('toDate');
  const to = toEl && toEl.value ? parseISO(toEl.value) : new Date();
  const from = new Date(to); from.setDate(to.getDate()-6);
  if(document.getElementById('fromDate')) document.getElementById('fromDate').value = toISODate(from);
  if(document.getElementById('toDate')) document.getElementById('toDate').value = toISODate(to);
  loadFilteredRange(list=> renderRekapTable(list,'Rekap Pekanan'));
}
function rekapBulanan(){
  // set fromDate to first day of month of toDate, toDate to last day
  const toEl = document.getElementById('toDate');
  const now = toEl && toEl.value ? parseISO(toEl.value) : new Date();
  const from = new Date(now.getFullYear(), now.getMonth(), 1);
  const to = new Date(now.getFullYear(), now.getMonth()+1, 0);
  if(document.getElementById('fromDate')) document.getElementById('fromDate').value = toISODate(from);
  if(document.getElementById('toDate')) document.getElementById('toDate').value = toISODate(to);
  loadFilteredRange(list=> renderRekapTable(list,'Rekap Bulanan'));
}
function tampilkanRekap(){ loadFilteredRange(list=> renderRekapTable(list,'Semua Data')); }

function renderRekapTable(absensiList, title){
  // build mapping: programs x naqib -> counts {Hadir,Izin,Sakit,Alfa}
  const programOptions = Array.from(document.querySelectorAll('#program option')).map(o=>o.textContent);
  const programs = programOptions; // use all programs from select
  const naqibs = Object.keys(dataSantri);
  // initialize counts
  const map = {}; // map[program][naqib] = {Hadir:0,Izin:0,Sakit:0,Alfa:0}
  programs.forEach(p => {
    map[p] = {};
    naqibs.forEach(nq => {
        map[p][nq] = {Hadir:0, Izin:0, Sakit:0, Alfa:0};
    });
});

  // optional filter by adminNaqib or program filters
  const adminNaqib = document.getElementById('adminNaqib').value;
  const filterProgram = document.getElementById('filterProgram').value;

  absensiList.forEach(a=>{
    if(filterProgram && a.program !== filterProgram) return;
    const prog = a.program;
    const nq = a.naqib;
    if(!map[prog]) {
      // if program not in select (edge), add it
      map[prog] = {};
    naqibs.forEach(nq2 => {
        map[prog][nq2] = {Hadir:0, Izin:0, Sakit:0, Alfa:0};
    });
    }
    if(adminNaqib && adminNaqib !== '' && nq !== adminNaqib) return;
    if(!map[prog][nq]) map[prog][nq] = {Hadir:0,Izin:0,Sakit:0,Alfa:0};
    const st = a.status;
    if(st === 'Hadir') map[prog][nq].Hadir++;
    else if(st === 'Izin') map[prog][nq].Izin++;
    else if(st === 'Sakit') map[prog][nq].Sakit++;
    else if(st === 'Alfa') map[prog][nq].Alfa++;
  });

  // render table
  const area = document.getElementById('rekapArea');
  let html = `<h4>${title}</h4><div class="small">Rentang: ${document.getElementById('fromDate').value}  ${document.getElementById('toDate').value}</div>`;
  html += `<table><thead><tr><th>Program</th>`;
  naqibs.forEach(nq=> html += `<th>${nq}</th>`);
  html += `<th>Total Per Program (%)</th></tr></thead><tbody>`;

  // for totals per naqib overall
  const totalPerNaqib = {}; // {naqib: {Hadir:..., Alfa:...}}
  naqibs.forEach(nq=> totalPerNaqib[nq] = {Hadir:0,Alfa:0});

  programs.forEach(prog=>{
    // skip program rows that have no data at all? We'll show all programs
    html += `<tr><td style="text-align:left">${prog}</td>`;
    let denomTotal = 0;
    let sumPercentages = 0;
    naqibs.forEach(nq=>{
      const c = (map[prog] && map[prog][nq]) ? map[prog][nq] : {Hadir:0,Izin:0,Sakit:0,Alfa:0};
      const hadir = c.Hadir || 0;
      const alfa = c.Alfa || 0;
      totalPerNaqib[nq].Hadir += hadir;
      totalPerNaqib[nq].Alfa += alfa;
      // per rules: Persentase = Hadir / (Hadir + Alfa)
      const denom = (hadir + alfa);
      const persen = denom === 0 ? 0 : Math.round((hadir/denom)*100);
      html += `<td>${persen}%</td>`;
      sumPercentages += persen;
      denomTotal++;
    });
    // total per program: rata-rata persentase di seluruh naqib (hanya bagi naqib yang ada)
    const totalProgramPercent = denomTotal === 0 ? 0 : Math.round(sumPercentages/denomTotal);
    html += `<td>${totalProgramPercent}%</td></tr>`;
  });

  // last row: Total per Naqib (%)
  html += `<tr><td style="text-align:left"><b>Total per Naqib (%)</b></td>`;
  naqibs.forEach(nq=>{
    const had = totalPerNaqib[nq].Hadir || 0;
    const alf = totalPerNaqib[nq].Alfa || 0;
    const denom = had + alf;
    const persen = denom === 0 ? 0 : Math.round((had/denom)*100);
    html += `<td><b>${persen}%</b></td>`;
  });
  // total overall average
  const overallPercents = naqibs.map(nq=>{
    const had = totalPerNaqib[nq].Hadir || 0; const alf = totalPerNaqib[nq].Alfa || 0;
    const denom = had + alf; return denom===0?0:Math.round((had/denom)*100);
  });
  const totalOverall = overallPercents.length===0 ? 0 : Math.round(overallPercents.reduce((a,b)=>a+b,0)/overallPercents.length);
  html += `<td><b>${totalOverall}%</b></td></tr>`;

  html += "</tbody></table>";
  area.innerHTML = html;
}

// DATE HELPERS
function toISODate(d){ const _d = (d instanceof Date) ? d : new Date(d); const y=_d.getFullYear(); const m=String(_d.getMonth()+1).padStart(2,'0'); const day=String(_d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function parseISO(str){ const p=str.split('-'); return new Date(p[0],p[1]-1,p[2]); }
function loadFilteredRange(cb){
  if(!window.loadAllAbsensi) return cb([]);
  const fromVal = document.getElementById('fromDate').value;
  const toVal   = document.getElementById('toDate').value;
  const from = fromVal ? parseISO(fromVal) : new Date(2000,0,1);
  const to   = toVal ? parseISO(toVal) : new Date();
  loadAllAbsensi(list=>{
    const f = list.filter(it=>{ if(!it.tanggal) return false; const d=parseISO(it.tanggal); return d>=from && d<=to; });
    cb(f);
  });
}

// REPORT: BULANAN PER SANTRI (sama seperti sebelumnya)
document.addEventListener('DOMContentLoaded', ()=>{
  const bn = document.getElementById('bulananNaqib');
  if(bn){
    bn.addEventListener('change', function(){
      const naqib = this.value;
      const sel = document.getElementById('bulananSantri');
      sel.innerHTML = '<option value="">-- Pilih Santri --</option>';
      if(dataSantri[naqib]) dataSantri[naqib].forEach(n=>{ const o=document.createElement('option'); o.value = n;
  o.textContent = n; sel.appendChild(o); });
    });
  }
});

function generateLaporanBulanan(){
  const naqib = document.getElementById('bulananNaqib').value;
  const santri = document.getElementById('bulananSantri').value;
  const bulan  = parseInt(document.getElementById('bulananBulan').value);
  const tahun  = parseInt(document.getElementById('bulananTahun').value);
  if(!naqib || !santri || isNaN(bulan)) return alert('Lengkapi semua pilihan.');
  const from = new Date(tahun, bulan, 1);
  const to   = new Date(tahun, bulan+1, 0);

  if(typeof loadAllAbsensi !== 'function') return alert('Firebase belum terhubung (absensi).');
  loadAllAbsensi(absensi=>{
    if(typeof loadAllPelanggaran !== 'function') return alert('Firebase belum terhubung (pelanggaran).');
    loadAllPelanggaran(pelanggaran=>{
      const abs = absensi.filter(a=> a.naqib===naqib && a.nama===santri && parseISO(a.tanggal)>=from && parseISO(a.tanggal)<=to );
      const pel = pelanggaran.filter(p=> p.naqib===naqib && p.nama===santri && parseISO(p.tanggal)>=from && parseISO(p.tanggal)<=to );

      const programs = [...new Set(abs.map(a=>a.program))];
      let tableAbsensi = "";
      programs.forEach((p,i)=>{
        const d = abs.filter(a=>a.program===p);
        const total = d.length;
        const hadir = d.filter(a=>a.status==="Hadir").length;
        const izin  = d.filter(a=>a.status==="Izin").length;
        const sakit = d.filter(a=>a.status==="Sakit").length;
        const alfa  = d.filter(a=>a.status==="Alfa").length;
        tableAbsensi += `<tr><td>${i+1}</td><td style="text-align:left">${p}</td><td>${percent(hadir,total)}</td><td>${percent(izin,total)}</td><td>${percent(sakit,total)}</td><td>${percent(alfa,total)}</td></tr>`;
      });

      let tablePelanggaran = "";
      pel.forEach((p,i)=>{
        tablePelanggaran += `<tr><td>${i+1}</td><td>${p.tanggal}</td><td>${p.jenis}</td><td style="text-align:left">${p.catatan||''}</td></tr>`;
      });

      document.getElementById('lapBulananHasil').innerHTML = `
        <div>
          <h2 style="margin:0">LAPORAN KEHADIRAN SANTRI DALAM PROGRAM HARIAN</h2>
          <p><b>Nama Santri:</b> ${santri}<br><b>Naqib:</b> ${naqib}<br><b>Bulan:</b> ${namaBulan(bulan)} ${tahun}</p>

          <h3>Persentase Kehadiran</h3>
          <table><thead><tr><th>No</th><th>Program</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th></tr></thead><tbody>
            ${tableAbsensi || '<tr><td colspan="6">Tidak ada data kehadiran</td></tr>'}
          </tbody></table>

          <h3 style="margin-top:16px">Laporan Pelanggaran</h3>
          <table><thead><tr><th>No</th><th>Tanggal</th><th>Pelanggaran</th><th>Catatan</th></tr></thead><tbody>
            ${tablePelanggaran || '<tr><td colspan="4">Tidak ada pelanggaran</td></tr>'}
          </tbody></table>
        </div>
      `;
      // store last report html for export convenience
      window._lastMonthlyReportHTML = document.getElementById('lapBulananHasil').innerHTML;
    });
  });
}

function percent(x,t){ return t===0 ? "0%" : Math.round((x/t)*100)+"%"; }
function namaBulan(b){ return ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][b]; }

// export PDF (sama seperti sebelumnya)
function exportLaporanBulananPDF(){
  const area = document.getElementById('lapBulananHasil');
  if(!area.innerText.trim()) return alert('Tampilkan laporan dulu.');
  const santri = document.getElementById('bulananSantri').value;
  const bulan  = parseInt(document.getElementById('bulananBulan').value);
  const tahun  = document.getElementById('bulananTahun').value;
  const fileName = `${santri}_${namaBulan(bulan)}_${tahun}.pdf`;

  if(!window.jspdf) return alert('jsPDF belum dimuat.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  doc.setFontSize(14);
  doc.text(`Laporan Bulanan Santri  ${santri}`, 40, 40);
  let y = 70;
  const tables = area.querySelectorAll('table');
  tables.forEach(tbl=>{
    const head = []; tbl.querySelectorAll('thead tr th').forEach(th=> head.push(th.innerText));
    const body = [];
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const row = []; tr.querySelectorAll('td').forEach(td=> row.push(td.innerText)); body.push(row);
    });
    doc.autoTable({ head:[head], body, startY:y, theme:'grid', margin:{left:40,right:40}, styles:{fontSize:9} });
    y = doc.lastAutoTable.finalY + 20;
  });
  doc.save(fileName);
}

// PELANGGARAN REKAP FUNCTIONS (sama)
function rekapPelanggaranAll(){ loadAllPelanggaran(list=>{ list=filterByDateRange(list); tampilRekapPelanggaran("Semua Pelanggaran", list); }); }
function rekapPelanggaranBaru(){ loadAllPelanggaran(list=>{ list=filterByDateRange(list); const f=list.filter(p=>p.kategori==="Baru"); tampilRekapPelanggaran("Pelanggaran Baru", f); }); }
function rekapPelanggaranBerulang(){ loadAllPelanggaran(list=>{ list=filterByDateRange(list); const f=list.filter(p=>p.kategori==="Berulang"); tampilRekapPelanggaran("Pelanggaran Berulang", f); }); }
function tampilRekapPelanggaran(title,list){
  const area=document.getElementById('rekapArea');
  if(list.length===0){ area.innerHTML="<b>Tidak ada data pelanggaran dalam rentang ini.</b>"; return; }
  list.sort((a,b)=> a.tanggal.localeCompare(b.tanggal));
  let html = `<h3>${title}</h3><h4>Statistik</h4><table><tr><th>Total</th><td>${list.length}</td></tr></table><h4>Histori</h4><table><thead><tr><th>Tanggal</th><th>Naqib</th><th>Santri</th><th>Kategori</th><th>Jenis</th><th>Level</th><th>Catatan</th></tr></thead><tbody>`;
  list.forEach(p=>{ html+=`<tr><td>${p.tanggal}</td><td>${p.naqib}</td><td>${p.nama}</td><td>${p.kategori}</td><td>${p.jenis}</td><td>${p.level}</td><td>${p.catatan}</td></tr>`; });
  html += "</tbody></table>";
  area.innerHTML = html;
}

// helper filterByDateRange used earlier
function filterByDateRange(items){
  const fromEl=document.getElementById('fromDate'), toEl=document.getElementById('toDate');
  if(!fromEl || !toEl) return items;
  const from=parseISO(fromEl.value), to=parseISO(toEl.value);
  return items.filter(it=>{ if(!it.tanggal) return false; const d=parseISO(it.tanggal); return d>=from && d<=to; });
}

// HAPUS SEMUA PELANGGARAN
function hapusSemuaPelanggaran(){
  if(!confirm("Hapus semua pelanggaran?")) return;
  if(window._firebaseRemovePelanggaran){ window._firebaseRemovePelanggaran().then(()=> alert("Semua pelanggaran dihapus.")); }
  else alert("Fungsi hapus tidak tersedia. Pastikan Firebase terhubung.");
}

/* =========================
   FUNGSI CEK KPI
   ========================= */
function cekKPI(){
  const toVal = document.getElementById('toDate').value;
  const toDate = toVal ? parseISO(toVal) : new Date();
  const month = toDate.getMonth();
  const year = toDate.getFullYear();

  const from = new Date(year, month, 1);
  const to   = new Date(year, month+1, 0);

  loadAllAbsensi(allAbsensi=>{
    loadAllPelanggaran(allPelanggaran=>{

      const abs = allAbsensi.filter(a=>{
        if(!a.tanggal) return false;
        const d = parseISO(a.tanggal);
        return d>=from && d<=to;
      });

      const pel = allPelanggaran.filter(p=>{
        if(!p.tanggal) return false;
        const d = parseISO(p.tanggal);
        return d>=from && d<=to;
      });

      const naqibs = Object.keys(dataSantri);

      const stats = {};
      naqibs.forEach(nq=> stats[nq] = {
        Hadir:0,
        Alfa:0,
        PelanggaranBaru:0,
        PelanggaranBerulang:0
      });

      abs.forEach(a=>{
        const nq = a.naqib;
        if(!stats[nq]) return;

        if(a.status === 'Hadir') stats[nq].Hadir++;
        else if(a.status === 'Alfa') stats[nq].Alfa++;
        // izin & sakit tidak dihitung
      });

      pel.forEach(p=>{
        const nq = p.naqib;
        if(!stats[nq]) return;

        if(p.kategori === 'Baru') stats[nq].PelanggaranBaru++;
        if(p.kategori === 'Berulang') stats[nq].PelanggaranBerulang++;
      });

      let html = `<h3>Hasil CEK KPI â€” ${namaBulan(month)} ${year}</h3>`;
      html += `<table><thead><tr>
        <th>Naqib</th>
        <th>Kehadiran (%)</th>
        <th>Pelanggaran Baru</th>
        <th>Pelanggaran Berulang</th>
        <th>Status KPI</th>
      </tr></thead><tbody>`;

      naqibs.forEach(nq=>{
        const s = stats[nq];

        const total = s.Hadir + s.Alfa;
        const hadirPercent = total === 0 ? 0 : Math.round((s.Hadir / total) * 100);

        const pass =
          hadirPercent >= 90 &&
          s.PelanggaranBaru <= 15 &&
          s.PelanggaranBerulang <= 5;

        html += `
          <tr>
            <td style="text-align:left">${nq}</td>
            <td>${hadirPercent}%</td>
            <td>${s.PelanggaranBaru}</td>
            <td>${s.PelanggaranBerulang}</td>
            <td style="font-weight:bold;color:${pass ? 'green':'red'}">
              ${pass ? 'Mencapai KPI' : 'Tidak Mencapai KPI'}
            </td>
          </tr>
        `;
      });

      html += "</tbody></table>";

      document.getElementById('rekapArea').innerHTML = html;
    });
  });
}

</script>

<!-- FIREBASE MODULE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0Ez2a85ZwQLR28U-yHpVmM3o8NMxZoLI",
    authDomain: "absensi-santri-fajrul-islam.firebaseapp.com",
    databaseURL: "https://absensi-santri-fajrul-islam-default-rtdb.firebaseio.com",
    projectId: "absensi-santri-fajrul-islam",
    storageBucket: "absensi-santri-fajrul-islam.appspot.com",
    messagingSenderId: "739928369926",
    appId: "1:739928369926:web:7e95375c3ddba0f584cdd07"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.simpanOnline = function(entry){ try{ push(ref(db,'absensi'), entry); }catch(e){ console.error(e); alert('Gagal simpan absensi: '+(e.message||e)); } };
  window.loadAllAbsensi = function(callback){ const r=ref(db,'absensi'); onValue(r, snapshot=>{ const data = snapshot.val() || {}; const arr = Object.keys(data).map(k=>data[k]); callback(arr); }, err=>{ console.error(err); callback([]); }); };

  window.simpanPelanggaranOnline = function(entry){ try{ push(ref(db,'pelanggaran'), entry); }catch(e){ console.error(e); alert('Gagal simpan pelanggaran: '+(e.message||e)); } };
  window.loadAllPelanggaran = function(callback){ const r=ref(db,'pelanggaran'); onValue(r, snapshot=>{ const data = snapshot.val() || {}; const arr = Object.keys(data).map(k=>data[k]); callback(arr); }, err=>{ console.error(err); callback([]); }); };

  window._firebaseRemovePelanggaran = function(){ return remove(ref(db,'pelanggaran')); };

  try{ if(!window.firebase){ window.firebase = { database: ()=>({ ref:(p)=>({ remove: ()=> remove(ref(db,p)) }) }) }; } }catch(e){}
</script>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

</body>
</html>
