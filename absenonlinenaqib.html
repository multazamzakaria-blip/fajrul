<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absensi Program Harian Santri Fajrul Islam</title>

<style>
  body{font-family:Arial, sans-serif;padding:20px;background:#f7f7f7}
  .card{background:white;border:1px solid #e0e0e0;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  .btn{padding:10px 15px;background:#1e88e5;color:white;border:none;border-radius:5px;cursor:pointer}
  .btn.alt{background:#43a047}
  label{display:inline-block;margin-bottom:6px}
  h2{margin-top:0}
  .small{color:#666;font-size:0.95em}
</style>
</head>

<body>

<h2>Absensi Program Harian Santri Fajrul Islam</h2>

<!-- LOGIN -->
<div class="card" id="loginPage">
  <h3>Login Naqib / Admin</h3>
  <label>Pilih User:</label>
  <select id="userSelect">
    <option value="">-- Pilih User --</option>
  </select>
  <br><br>
  <label>Kode Akses:</label>
  <input type="password" id="kode"><br><br>
  <button class="btn" onclick="login()">Masuk</button>
  <p class="small">Isi dengan jujur dan teliti</p>
</div>

<!-- ABSENSI NAQIB -->
<div class="card" id="absensiPage" style="display:none;">
  <h3 id="naqibLabel">Form Absensi</h3>

  <label>Tanggal: <input type="date" id="tanggal"></label><br><br>

  <label>Program:</label>
  <select id="program">
    <option>TAHAJJUD</option>
    <option>SHALAT SUBUH</option>
    <option>JOGING PAGI</option>
    <option>SHALAT ZUHUR</option>
    <option>TIDUR SIANG</option>
    <option>SHALAT ASHAR</option>
    <option>SHALAT MAGHRIB</option>
    <option>SHALAT ISYA</option>
    <option>TIDUR MALAM</option>
    <option>PIKET KEBERSIHAN</option>
  </select>

  <h4>Daftar Santri</h4>
  <button class="btn" onclick="checkAll()">Hadir Semua</button>

  <table>
    <thead>
      <tr><th>Nama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th></tr>
    </thead>
    <tbody id="santriTable"></tbody>
  </table>

  <br>
  <button class="btn" onclick="simpan()">Simpan</button>
  <button class="btn alt" onclick="logout()">Logout</button>
</div>

<!-- ADMIN -->
<div class="card" id="adminPage" style="display:none;">
  <h3>Halaman Admin</h3>

  <label>Pilih Naqib:</label>
  <select id="adminNaqib">
    <option value="">Semua Naqib</option>
  </select>

  <br><br>

  <button class="btn" onclick="loadRekap()">Tampilkan Rekap</button>
  <button class="btn alt" onclick="exportCSV()">Export CSV</button>

  <h4>Hasil Rekap</h4>
  <div id="rekap">Memuat rekap...</div>

  <br>
  <button class="btn" onclick="logout()">Logout</button>
</div>

<script>
// ======================= DATA USER & SANTRI =======================
const users = [
  { id: 'Admin', label: 'Admin', role: 'admin', code: 'ADMIN123' },
  { id: 'Regen', label: 'Naqib Regen', role: 'naqib', code: 'REGEN111', naqibName: 'Regen' },
  { id: 'Kamal', label: 'Naqib Kamal', role: 'naqib', code: 'KAMAL111', naqibName: 'Kamal' },
  { id: 'Favian', label: 'Naqib Favian', role: 'naqib', code: 'FAVIAN111', naqibName: 'Favian' },
  { id: 'Dimas', label: 'Naqib Dimas', role: 'naqib', code: 'DIMAS111', naqibName: 'Dimas' },
  { id: 'Shafwan', label: 'Naqib Shafwan', role: 'naqib', code: 'SHAFWAN111', naqibName: 'Shafwan' },
  { id: 'Fatimah', label: 'Naqibah Fatimah', role: 'naqib', code: 'FATIMAH111', naqibName: 'Fatimah' },
  { id: 'Evita', label: 'Naqibah Evita', role: 'naqib', code: 'EVITA111', naqibName: 'Evita' }
];

const dataSantri = {
  "Regen": ["AHMAD MAULANA","JUANDA NUR ILHAM","NAJMIHADI SYAUQII TAMAAM","NIZAM KABISAT","MOHAMMAD IKHSAN HAIRULI","REYFAS RAMADHAN","EZA FEBRI AL FADZRI","HAFIDZ AL ROZI","ANDES AFENDRA","FEBRI GHALIH AL FAROBI","DANANG PRASDITYA SANTOSO","MUHAMMAD RAID MAHRUS","MUHAMMAD DIRGATAMA","CANZA RYANDA HUTASUHUT","FALIZH DAFFA QATRUNNADA","DAFFA AL MUSYARI","RAFI RAMADHAN","WAHYU REYDINATA","AKBAR PRAYOGA","VERY SYACH","MUHAMMAD AL FALAH"],

  "Kamal": ["ADITYA PUTRA IBRAHIM","AIRLANGGA AZKA ABQORI","AQIELA MARSYAH","BRILLY HANDRIAN","DARREN ATHAYA","DZIKRI MUDHOFFAR","ELLENO QUTHBIE HERMAWAN","FADIL NURHALIM","GABRIEL AL FATIH","HADINATA SAPUTRA","MIKO VAJAR","MUHAMMAD ALMISKY PRATAMA","MUHAMMAD AQIL RIDHO","MUHAMMAD IZAM SAPUTRA","MUHAMMAD SYAKIR HUTABARAT","MUHAMMAD ZIYAD ZHAZHA","MUHAMMAD YASIR AL FAZAR JHIRA","RAFA"],

  "Favian": ["ANGGA PRATAMA PUTRA","PRAWIRO PUJO TUNGGAL JATI","MUHAMMAD MARPIN","MARFEL SAPUTRA","MELDI NOVRIANSYAH","FAUZAN IBNI JABAR","MUHAMMAD FADHIL BUANA","QHEIZAN ALQIZA ARISDA","REZFY FAKHRYAZKA","MIKA RAHEL YUSUF","KI AGUS MUHAMMAD ABDULLAH SHIDDIQ AGTSALI","ARYA DIFA ALSYA","REYNALDI MALIK IBRAHIM ALFARIDZI","MUHAMMAD XAVI NF","MUHAMMAD FAISAL FIKRIANSYAH","HAFIDZ ALRIZKY","NAUFAL AKBAR ALKHATIRI","FARAZH SAYYID PUTRA KENEGA","SYAHRUL RAMADHAN","LUTHFAN ADZAKI","MUHAMMAD ABIL IRWANSYAH","ALIF SAMUDRA","FAHRIE OKTAVIRANO FITRIS"],

  "Dimas": ["GHOZY FATURRAHMAN","MUHAMMAD THOORIQ","AHMAD RIYADI","ALIF MUHAMMAD YUSUF","BASRI AL HAZIQ ZULFAHMI","MUHAMMAD FAQIH HAFIDZALLAH","ABDULLAH MUKTI HAFIDZALLAH","DEDI SETIADI","FAKHRI AL MUZAKKI","ILHAM MUKMIN AL FARABI","MUHAMMAD ALLAM NUR HUSAIN","MUHAMMAD FIRAAS AL INSYIROH","NABIL NAJMI","SATRIO ABIMAYU","TEGAR HIDAYAT","WAFII FADHLURROHMAN","MUHAMMAD RIJALUL KAMIL","ALVIN HERFIANTINO","ZAHIR ZIBRAN","RADEN AZAA PANCA PUTRA"],

  "Shafwan": ["AHMAD FARHAAN","ANUGRAH PRATAMA","CAHYIS ISZAM","DIKKI KURNIAWAN","FAHRY AKBAR RAMDHANI","HABIB RAMADHAN","IHZA TRINANDI","ILHAM","M.ARYA MAHDI WAFI EL-FAUZANI","MAHESA AULIA GIFFARI","MUHAMAD YUSUF ARROSIYD","MUHAMMAD RAYYAN HAFIZ","MUHAMMAD USAMAH","NAFIS","RAKA SEPTIAN","RENAL MARTIN","ROHADIN FIRDAUS AL QAUSAR","ROID AFDAL","ZULFAKIH HAERUNNASIHIN"],

  "Fatimah": ["NILAM CAHYA","QELZA RAMADHANI ATH THAHIRAH","ASHIFA FITRI RAMADHONI","ADIBA AILA KHANZA","AISYAH NUR KHALIFAH","NYAYU MARLITSA ARDHANI","WILDA","WINDY WINDARI","ALFERA DESTIA","AISYAH NURUL AULIA","NESSYA RAMADHANY","AMIRAH BALQIS RAHADATUL A'ISYAH","EARLYTA ARSYFA SALSABILA","DAFIA NAFLA SYAKIRA","ANISYA SEPTIANI"],

  "Evita": ["BILQIS NUR ANISAH","JESSICA PUTRY AYRA","GHENIS ANDIENTIAZ","DINA RUHAYAH","MALWA SHAGIRAH","PITRI RAMADANI","GRINNETA NALANI PUTRI","INAYAH NOURAH ANINDYA","SHELENA","FITRAH KIRANA"]
};

let currentUser = null;

// ======================= INIT UI =======================
function init(){
  const sel = document.getElementById("userSelect");
  sel.innerHTML = '<option value="">-- Pilih User --</option>';
  users.forEach(u=>{
    const o=document.createElement("option");
    o.value=u.id; o.text=u.label;
    sel.appendChild(o);
  });

  const adminSel = document.getElementById("adminNaqib");
  adminSel.innerHTML = '<option value="">Semua Naqib</option>';
  Object.keys(dataSantri).forEach(k=>{
    const o=document.createElement("option");
    o.value=k; o.text=k;
    adminSel.appendChild(o);
  });
}
window.addEventListener("DOMContentLoaded", init);

// ======================= LOGIN =======================
function login(){
  const userId = document.getElementById("userSelect").value;
  const kode = document.getElementById("kode").value.trim();
  if(!userId) return alert("Pilih user.");
  const user = users.find(u=> u.id===userId);
  if(!user) return alert("User tidak ditemukan");
  if(kode !== user.code) return alert("Kode akses salah.");
  
  currentUser = user;

  if(user.role==="admin"){
    document.getElementById("loginPage").style.display="none";
    document.getElementById("adminPage").style.display="block";
    loadRekap();
  } else {
    document.getElementById("loginPage").style.display="none";
    document.getElementById("absensiPage").style.display="block";
    openNaqibPage(user);
  }
}

function logout(){
  currentUser=null;
  document.getElementById("loginPage").style.display="block";
  document.getElementById("absensiPage").style.display="none";
  document.getElementById("adminPage").style.display="none";
}

// Build table
function openNaqibPage(user){
  document.getElementById("naqibLabel").innerText = "Naqib: " + user.label;
  const santri = dataSantri[user.naqibName] || [];
  const body = document.getElementById("santriTable");
  body.innerHTML="";

  santri.forEach(n=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${n}</td>
      <td><input type="radio" name="${escapeName(n)}" value="Hadir" checked></td>
      <td><input type="radio" name="${escapeName(n)}" value="Izin"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Sakit"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Alfa"></td>
    `;
    body.appendChild(tr);
  });
}

function escapeName(n){ return n.replace(/[^a-z0-9]/gi,"_"); }

function checkAll(){
  document.querySelectorAll('input[value="Hadir"]').forEach(r=> r.checked=true);
}

// ======================= FIREBASE ONLINE SAVE =======================
function simpan(){
  const tanggal = document.getElementById("tanggal").value || new Date().toISOString().slice(0,10);
  const program = document.getElementById("program").value;
  const naqib = currentUser.naqibName;

  const rows = document.querySelectorAll("#santriTable tr");
  rows.forEach(row=>{
    const nama = row.children[0].innerText;
    const st = document.querySelector(`input[name="${escapeName(nama)}"]:checked`);
    const status = st ? st.value : "Hadir";

    simpanOnline({tanggal, program, naqib, nama, status});
  });

  alert("Absensi tersimpan ke database online.");
}

// ======================= EXPORT CSV =======================
function exportCSV(){
  loadAllAbsensi(data=>{
    const rows = [["tanggal","program","naqib","nama","status"]];
    data.forEach(r=> rows.push([r.tanggal,r.program,r.naqib,r.nama,r.status]));

    const csv = rows.map(r=> r.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url; a.download="absensi.csv"; a.click();
    URL.revokeObjectURL(url);
  });
}

// ======================= REKAP ONLINE =======================
function loadRekap(){
  loadAllAbsensi(data=>{
    if(data.length===0){
      document.getElementById("rekap").innerHTML="<b>Belum ada data.</b>";
      return;
    }

    const filterNaqib = document.getElementById("adminNaqib").value;
    let filtered = data;
    if(filterNaqib) filtered = data.filter(r=> r.naqib === filterNaqib);

    const total = filtered.length;
    const hadir = filtered.filter(r=> r.status=="Hadir").length;
    const izin = filtered.filter(r=> r.status=="Izin").length;
    const sakit = filtered.filter(r=> r.status=="Sakit").length;
    const alfa = filtered.filter(r=> r.status=="Alfa").length;
    const persen = total? ((hadir/total)*100).toFixed(1):0;

    let html = `
      <p>
      <b>Total Data:</b> ${total}<br>
      <b>Total Hadir:</b> ${hadir}<br>
      <b>Persentase Kehadiran:</b> ${persen}%
      </p>
    `;

    html += "<hr><h4>Per Naqib</h4>";
    Object.keys(dataSantri).forEach(nq=>{
      const d = data.filter(r=> r.naqib===nq);
      if(d.length===0){
        html+=`<p><b>${nq}</b>: Tidak ada data.</p>`;
      } else {
        const H = d.filter(x=>x.status=="Hadir").length;
        const I = d.filter(x=>x.status=="Izin").length;
        const S = d.filter(x=>x.status=="Sakit").length;
        const A = d.filter(x=>x.status=="Alfa").length;
        const P = ((H/d.length)*100).toFixed(1);
        html+=`<p><b>${nq}</b> â€” H:${H} | I:${I} | S:${S} | A:${A} | <b>${P}% hadir</b></p>`;
      }
    });

    html += "<hr><h4>Tabel Lengkap</h4>";
    html += "<table><tr><th>Tanggal</th><th>Program</th><th>Naqib</th><th>Santri</th><th>Status</th></tr>";

    filtered.forEach(r=>{
      html += `<tr>
        <td>${r.tanggal}</td>
        <td>${r.program}</td>
        <td>${r.naqib}</td>
        <td>${r.nama}</td>
        <td>${r.status}</td>
      </tr>`;
    });

    html+="</table>";
    document.getElementById("rekap").innerHTML = html;
  });
}
</script>

<!-- ======================= FIREBASE MODULE ======================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB0Ez2a85ZwQLR28U-yHpVmM3o8NMxZoLI",
  authDomain: "absensi-santri-fajrul-islam.firebaseapp.com",
  databaseURL: "https://absensi-santri-fajrul-islam-default-rtdb.firebaseio.com",
  projectId: "absensi-santri-fajrul-islam",
  storageBucket: "absensi-santri-fajrul-islam.appspot.com",
  messagingSenderId: "739928369926",
  appId: "1:739928369926:web:7e95375c3ddba0f584cdd07"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// SIMPAN ONLINE
window.simpanOnline = function(entry){
  push(ref(db,"absensi"), entry);
};

// LOAD ONLINE
window.loadAllAbsensi = function(callback){
  onValue(ref(db,"absensi"), snapshot=>{
    const d = snapshot.val() || {};
    callback(Object.values(d));
  });
};
</script>

</body>
</html>
