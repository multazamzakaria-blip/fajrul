<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kedisiplinan Santri — Absensi & Rekap Pelanggaran</title>

<style>
  body{font-family:Arial, sans-serif;padding:18px;background:#f7f7f7}
  h1,h2{margin-top:0}
  .card{background:#fff;border:1px solid #e6e6e6;padding:18px;border-radius:10px;
        margin-bottom:18px;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
  .hidden{display:none}
  label{display:inline-block;margin:6px 0;font-weight:bold}
  input,select,textarea{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .btn{padding:10px 16px;background:#1e88e5;color:#fff;border:none;border-radius:6px;
       cursor:pointer;margin-right:8px;font-size:1rem}
  .btn.alt{background:#43a047}
  .btn.warn{background:#f57c00}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:0.95rem;background:#fff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:180px}
  .note{background:#fffbe6;border:1px solid #ffe58f;padding:10px;border-radius:6px;margin-top:12px}
  hr.sep{border:none;border-top:1px solid #eee;margin:12px 0}
  @media(max-width:900px){ .row{flex-direction:column} }
</style>

</head>

<body>
<h1>Kedisiplinan Santri</h1>
<p>Absensi Online dan Rekap Pelanggaran</p>

<!-- LOGIN -->
<div class="card" id="loginPage">
  <h3>Login Naqib / Admin</h3>
  <label>Pilih User:</label>
  <select id="userSelect"><option value="">-- Pilih User --</option></select>

  <label>Kode Akses:</label>
  <input type="password" id="kode">

  <br><br>
  <button class="btn" onclick="login()">Masuk</button>

  <p style="color:#666;margin-top:10px">Isi dengan teliti dan jujur!</p>
</div>
<!-- NAQIB DASHBOARD -->
<div class="card hidden" id="naqibDashboard">
  <h3 id="naqibLabel">Naqib</h3>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <div>
      <button class="btn" onclick="showSection('absensiPage')">Absensi Program Harian</button>
      <button class="btn alt" onclick="showSection('pelanggaranPage')">Form Pelanggaran Santri</button>
    </div>

    <div style="margin-left:auto">
      <button class="btn warn" onclick="logout()">Logout</button>
    </div>
  </div>
</div>


<!-- ABSENSI -->
<div class="card hidden" id="absensiPage">
  <h3>Form Absensi — <span id="naqibLabel2"></span></h3>

  <div class="row">
    <div class="col">
      <label>Tanggal:</label>
      <input type="date" id="tanggal">
    </div>

    <div class="col">
      <label>Program:</label>
      <select id="program">
        <option>TAHAJJUD</option>
        <option>SHALAT SUBUH</option>
        <option>JOGING PAGI</option>
        <option>SHALAT ZUHUR</option>
        <option>TIDUR SIANG</option>
        <option>SHALAT ASHAR</option>
        <option>SHALAT MAGHRIB</option>
        <option>SHALAT ISYA</option>
        <option>TIDUR MALAM</option>
        <option>PIKET KEBERSIHAN</option>
      </select>
    </div>
  </div>

  <h4>Daftar Santri</h4>
  <button class="btn" onclick="checkAll()">Hadir Semua</button>

  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th>Hadir</th>
        <th>Izin</th>
        <th>Sakit</th>
        <th>Alfa</th>
      </tr>
    </thead>

    <tbody id="santriTable"></tbody>
  </table>

  <br>
  <button class="btn alt" onclick="simpan()">Simpan Absensi</button>
  <button class="btn" style="background:#999" onclick="showSection('naqibDashboard')">Kembali</button>
</div>
<!-- PELANGGARAN -->
<div class="card hidden" id="pelanggaranPage">
  <h3>Form Pelanggaran Santri</h3>

  <div class="row">
    <div class="col">
      <label>Naqib:</label>
      <input type="text" id="pelNaqib" readonly style="background:#eee">
    </div>

    <div class="col">
      <label>Nama Santri:</label>
      <select id="pelSantri">
        <option value="">-- Pilih Santri --</option>
      </select>
    </div>

    <div class="col">
      <label>Tanggal:</label>
      <input type="date" id="pelTanggal">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="col">
      <label>Kategori:</label>
      <select id="pelKategori">
        <option value="Baru">Baru</option>
        <option value="Berulang">Berulang</option>
      </select>
    </div>

    <div class="col">
      <label>Jenis Pelanggaran:</label>
      <input type="text" id="pelJenis" placeholder="Contoh: Tidak Shalat, Ribut, dll">
    </div>

    <div class="col">
      <label>Level:</label>
      <select id="pelLevel">
        <option>Ringan</option>
        <option>Sedang</option>
        <option>Berat</option>
      </select>
    </div>
  </div>

  <label style="margin-top:10px">Catatan:</label>
  <textarea id="pelCatatan" rows="3"></textarea>

  <br><br>
  <button class="btn alt" onclick="simpanPelanggaran()">Simpan Pelanggaran</button>
  <button class="btn" style="background:#999" onclick="showSection('naqibDashboard')">Kembali</button>

  <p class="note">
    Anti-duplikasi: Pelanggaran <b>Nama + Jenis + Tanggal</b> tidak boleh tercatat dua kali.
  </p>
</div>


<!-- ADMIN PAGE -->
<div class="card hidden" id="adminPage">
  <h3>Rekap Kedisiplinan Santri (Admin)</h3>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
    <div>
      <button class="btn" style="background:#00897b" onclick="showSection('lapBulananPage')">
        Laporan Bulanan Per Santri
      </button>

      <button class="btn" style="background:#3949ab" onclick="showSection('auditPage')">
        Audit Kebersihan
      </button>
    </div>

    <div style="margin-left:auto">
      <button class="btn" onclick="rekapHarian()">Rekap Harian</button>
      <button class="btn" onclick="rekapPekanan()">Rekap Pekanan</button>
      <button class="btn" onclick="rekapBulanan()">Rekap Bulanan</button>
      <button class="btn alt" onclick="tampilkanRekap()">Tampilkan Semua</button>
<button class="btn" style="background:#ff9800" onclick="cekKPI()">CEK KPI</button>
<button class="btn alt" onclick="showSection('laporanAuditPage')">Laporan Audit</button>


    </div>
  </div>
  <div class="row">
    <div class="col">
      <label>Dari:</label>
      <input type="date" id="fromDate">
    </div>

    <div class="col">
      <label>Sampai:</label>
      <input type="date" id="toDate">
    </div>

    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="adminNaqib">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="col">
      <label>Program:</label>
      <select id="filterProgram">
        <option value="">Semua</option>
        <option>TAHAJJUD</option>
        <option>SHALAT SUBUH</option>
        <option>JOGING PAGI</option>
        <option>SHALAT ZUHUR</option>
        <option>TIDUR SIANG</option>
        <option>SHALAT ASHAR</option>
        <option>SHALAT MAGHRIB</option>
        <option>SHALAT ISYA</option>
        <option>TIDUR MALAM</option>
        <option>PIKET KEBERSIHAN</option>
      </select>
    </div>
  </div>

  <br>

  <button class="btn" style="background:#6a1b9a" onclick="rekapPelanggaranAll()">Rekap Pelanggaran</button>
  <button class="btn" style="background:#c2185b" onclick="rekapPelanggaranBaru()">Pelanggaran Baru</button>
  <button class="btn" style="background:#d81b60" onclick="rekapPelanggaranBerulang()">Pelanggaran Berulang</button>
  <button class="btn" style="background:#d32f2f;color:white" onclick="hapusSemuaPelanggaran()">Hapus Semua Pelanggaran</button>

  <button class="btn" style="background:#999" onclick="logout()">Logout</button>

  <hr class="sep">
  <h4 style="margin-top:12px">Hasil Rekap:</h4>
  <div id="rekapArea" style="min-height:200px">Silakan pilih rentang tanggal.</div>
</div>



<!-- LAPORAN BULANAN PER SANTRI -->
<div class="card hidden" id="lapBulananPage">
  <h3>Laporan Bulanan Per Santri</h3>

  <div class="row">
    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="bulananNaqib">
        <option value="">-- Pilih Naqib --</option>
      </select>
    </div>

    <div class="col">
      <label>Pilih Santri:</label>
      <select id="bulananSantri">
        <option value="">-- Pilih Santri --</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>Bulan:</label>
      <select id="bulananBulan">
        <option value="">-- Pilih Bulan --</option>
        <option value="0">Januari</option>
        <option value="1">Februari</option>
        <option value="2">Maret</option>
        <option value="3">April</option>
        <option value="4">Mei</option>
        <option value="5">Juni</option>
        <option value="6">Juli</option>
        <option value="7">Agustus</option>
        <option value="8">September</option>
        <option value="9">Oktober</option>
        <option value="10">November</option>
        <option value="11">Desember</option>
      </select>
    </div>

    <div class="col">
      <label>Tahun:</label>
      <input type="number" id="bulananTahun" min="2020" max="2099" value="2025">
    </div>
  </div>

  <br>
  <button class="btn alt" onclick="generateLaporanBulanan()">Tampilkan</button>
  <button class="btn" style="background:#795548" onclick="exportLaporanBulananPDF()">Export PDF</button>
  <button class="btn" style="background:#999" onclick="showSection('adminPage')">Kembali</button>

  <h3 style="margin-top:20px">Hasil Laporan:</h3>
  <div id="lapBulananHasil"></div>
</div>

<!-- LAPORAN AUDIT KEBERSIHAN -->
<div class="card hidden" id="laporanAuditPage">
  <h3>Laporan Audit Kebersihan</h3>

  <div class="row">
    <div class="col">
      <label>Dari Tanggal:</label>
      <input type="date" id="auditFrom">
    </div>

    <div class="col">
      <label>Sampai Tanggal:</label>
      <input type="date" id="auditTo">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="lapAuditNaqib">
        <option value="">Semua</option>
      </select>
    </div>
  </div>

  <br>
  <button class="btn" onclick="loadLaporanAudit()">Tampilkan</button>
  <button class="btn alt" style="background:#999" onclick="showSection('adminPage')">Kembali</button>

  <hr>
  <div id="hasilAuditList">Silakan pilih rentang tanggal.</div>
</div>


<!-- =====================
     AUDIT KEBERSIHAN (HTML)
===================== -->
<div class="card hidden" id="auditPage">
  <h3>Audit Kebersihan Asrama</h3>

  <div class="row">
    <div class="col">
      <label>Tanggal Audit:</label>
      <input type="date" id="auditTanggal">
    </div>

    <div class="col">
      <label>Supervisor/Admin:</label>
      <input type="text" id="auditSupervisor" placeholder="Nama pemeriksa">
    </div>

    <div class="col">
      <label>Pilih Naqib:</label>
      <select id="auditNaqib">
        <option value="">-- Pilih Naqib --</option>
      </select>
    </div>
  </div>

  <hr>

  <h4>Skor Kebersihan (0–20 per poin)</h4>

  <table>
    <thead>
      <tr>
        <th>Aspek</th>
        <th>Skor (0–20)</th>
      </tr>
    </thead>

    <tbody>
      <tr>
        <td>Kebersihan Lantai</td>
        <td><input type="number" id="auditLantai" min="0" max="20" value="0"></td>
      </tr>

      <tr>
        <td>Kerapian Tempat Tidur</td>
        <td><input type="number" id="auditTempatTidur" min="0" max="20" value="0"></td>
      </tr>

      <tr>
        <td>Kerapian Lemari/Koper</td>
        <td><input type="number" id="auditLemari" min="0" max="20" value="0"></td>
      </tr>

      <tr>
        <td>Kebersihan Kamar Mandi</td>
        <td><input type="number" id="auditKamarMandi" min="0" max="20" value="0"></td>
      </tr>

      <tr>
        <td>Area Jemuran & Barang Pribadi</td>
        <td><input type="number" id="auditArea" min="0" max="20" value="0"></td>
      </tr>
    </tbody>
  </table>

  <br>
  <h4>Total Skor: <span id="auditTotal">0</span> / 100</h4>
  <p class="small">Minimal skor yang memenuhi KPI: <b>85/100</b></p>
<!-- CATATAN SUPERVISOR -->
<div style="margin-top:20px">
  <label style="font-weight:bold">Catatan Supervisor:</label>
  <textarea id="auditCatatan" rows="4"
    placeholder="Tuliskan catatan temuan atau tindak lanjut..."
    style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;"></textarea>
</div>
  <br>
  <button class="btn alt" onclick="simpanAudit()">Simpan Audit</button>
  <button class="btn" style="background:#999" onclick="showSection('adminPage')">Kembali</button>
</div>
<script>
// -------------------- DATA USERS & SANTRI --------------------
const users = [
  { id: 'Admin', label: 'Admin', role: 'admin', code: 'ADMIN123' },
  { id: 'Regen', label: 'Naqib Regen', role: 'naqib', code: 'REGEN111', naqibName:'Regen' },
  { id: 'Kamal', label: 'Naqib Kamal', role: 'naqib', code: 'KAMAL111', naqibName:'Kamal' },
  { id: 'Favian', label: 'Naqib Favian', role: 'naqib', code: 'FAVIAN111', naqibName:'Favian' },
  { id: 'Dimas', label: 'Naqib Dimas', role: 'naqib', code: 'DIMAS111', naqibName:'Dimas' },
  { id: 'Shafwan', label: 'Naqib Shafwan', role: 'naqib', code: 'SHAFWAN111', naqibName:'Shafwan' },
  { id: 'Fatimah', label: 'Naqibah Fatimah', role: 'naqib', code: 'FATIMAH111', naqibName:'Fatimah' },
  { id: 'Evita', label: 'Naqibah Evita', role: 'naqib', code: 'EVITA111', naqibName:'Evita' }
];

const dataSantri = {
  "Regen":[ "AHMAD MAULANA","JUANDA NUR ILHAM","NAJMIHADI SYAUQII TAMAAM","NIZAM KABISAT","MOHAMMAD IKHSAN HAIRULI","REYFAS RAMADHAN","EZA FEBRI AL FADZRI","HAFIDZ AL ROZI","ANDES AFENDRA","FEBRI GHALIH AL FAROBI","DANANG PRASDITYA SANTOSO","MUHAMMAD RAID MAHRUS","MUHAMMAD DIRGATAMA","CANZA RYANDA HUTASUHUT","FALIZH DAFFA QATRUNNADA","DAFFA AL MUSYARI","RAFI RAMADHAN","WAHYU REYDINATA","AKBAR PRAYOGA","VERY SYACH","MUHAMMAD AL FALAH"],
  "Kamal":[ "ADITYA PUTRA IBRAHIM","AIRLANGGA AZKA ABQORI","AQIELA MARSYAH","BRILLY HANDRIAN","DARREN ATHAYA","DZIKRI MUDHOFFAR","ELLENO QUTHBIE HERMAWAN","FADIL NURHALIM","GABRIEL AL FATIH","HADINATA SAPUTRA","MIKO VAJAR","MUHAMMAD ALMISKY PRATAMA","MUHAMMAD AQIL RIDHO","MUHAMMAD IZAM SAPUTRA","MUHAMMAD SYAKIR HUTABARAT","MUHAMMAD ZIYAD ZHAZHA","MUHAMMAD YASIR AL FAZAR JHIRA","RAFA"],
  "Favian":[ "ANGGA PRATAMA PUTRA","PRAWIRO PUJO TUNGGAL JATI","MUHAMMAD MARPIN","MARFEL SAPUTRA","MELDI NOVRIANSYAH","FAUZAN IBNI JABAR","MUHAMMAD FADHIL BUANA","QHEIZAN ALQIZA ARISDA","REZFY FAKHRYAZKA","MIKA RAHEL YUSUF","KI AGUS MUHAMMAD ABDULLAH SHIDDIQ AGTSALI","ARYA DIFA ALSYA","REYNALDI MALIK IBRAHIM ALFARIDZI","MUHAMMAD XAVI NF","MUHAMMAD FAISAL FIKRIANSYAH","HAFIDZ ALRIZKY","NAUFAL AKBAR ALKHATIRI","FARAZH SAYYID PUTRA KENEGA","SYAHRUL RAMADHAN","LUTHFAN ADZAKI","MUHAMMAD ABIL IRWANSYAH","ALIF SAMUDRA","FAHRIE OKTAVIRANO FITRIS"],
  "Dimas":[ "GHOZY FATURRAHMAN","MUHAMMAD THOORIQ","AHMAD RIYADI","ALIF MUHAMMAD YUSUF","BASRI AL HAZIQ ZULFAHMI","MUHAMMAD FAQIH HAFIDZALLAH","ABDULLAH MUKTI HAFIDZALLAH","DEDI SETIADI","FAKHRI AL MUZAKKI","ILHAM MUKMIN AL FARABI","MUHAMMAD ALLAM NUR HUSAIN","MUHAMMAD FIRAAS AL INSYIROH","NABIL NAJMI","SATRIO ABIMAYU","TEGAR HIDAYAT","WAFII FADHLURROHMAN","MUHAMMAD RIJALUL KAMIL","ALVIN HERFIANTINO","ZAHIR ZIBRAN","RADEN AZAA PANCA PUTRA"],
  "Shafwan":[ "AHMAD FARHAAN","ANUGRAH PRATAMA","CAHYIS ISZAM","DIKKI KURNIAWAN","FAHRY AKBAR RAMDHANI","HABIB RAMADHAN","IHZA TRINANDI","ILHAM","M.ARYA MAHDI WAFI EL-FAUZANI","MAHESA AULIA GIFFARI","MUHAMAD YUSUF ARROSIYD","MUHAMMAD RAYYAN HAFIZ","MUHAMMAD USAMAH","NAFIS","RAKA SEPTIAN","RENAL MARTIN","ROHADIN FIRDAUS AL QAUSAR","ROID AFDAL","ZULFAKIH HAERUNNASIHIN"],
  "Fatimah":[ "NILAM CAHYA","QELZA RAMADHANI ATH THAHIRAH","ASHIFA FITRI RAMADHONI","ADIBA AILA KHANZA","AISYAH NUR KHALIFAH","NYAYU MARLITSA ARDHANI","WILDA","WINDY WINDARI","ALFERA DESTIA","AISYAH NURUL AULIA","NESSYA RAMADHANY","AMIRAH BALQIS RAHADATUL A'ISYAH","EARLYTA ARSYFA SALSABILA","DAFIA NAFLA SYAKIRA","ANISYA SEPTIANI"],
  "Evita":[ "BILQIS NUR ANISAH","JESSICA PUTRY AYRA","GHENIS ANDIENTIAZ","DINA RUHAYAH","MALWA SHAGIRAH","PITRI RAMADANI","GRINNETA NALANI PUTRI","INAYAH NOURAH ANINDYA","SHELENA","FITRAH KIRANA"]
};

let currentUser = null;



// INIT
function init(){
  const sel = document.getElementById('userSelect');
  sel.innerHTML = '<option value="">-- Pilih User --</option>';
  users.forEach(u=>{
    const o=document.createElement('option');
    o.value=u.id;
    o.textContent=u.label;
    sel.appendChild(o);
  });

  const adminSel = document.getElementById('adminNaqib');
  if(adminSel){
    adminSel.innerHTML = '<option value="">Semua</option>';
    Object.keys(dataSantri).forEach(k=>{
      const o=document.createElement('option');
      o.value=k;
      o.textContent=k;
      adminSel.appendChild(o);
    });
  }

  // Untuk laporan bulanan
  const bn = document.getElementById('bulananNaqib');
  if(bn){
    bn.innerHTML = '<option value="">-- Pilih Naqib --</option>';
    Object.keys(dataSantri).forEach(k=>{
      const o=document.createElement('option');
      o.value=k;
      o.textContent=k;
      bn.appendChild(o);
    });
  }

  const today = new Date();
  const ymd = toISODate(today);
  const from = new Date();
  from.setDate(today.getDate()-7);

  if(document.getElementById('tanggal')) document.getElementById('tanggal').value = ymd;
  if(document.getElementById('pelTanggal')) document.getElementById('pelTanggal').value = ymd;
  if(document.getElementById('fromDate')) document.getElementById('fromDate').value = toISODate(from);
  if(document.getElementById('toDate')) document.getElementById('toDate').value = ymd;
  if(document.getElementById('bulananTahun')) document.getElementById('bulananTahun').value = today.getFullYear();
}

window.addEventListener('DOMContentLoaded', init);



// NAV
function showSection(id){
  const list=[
    'loginPage','naqibDashboard','absensiPage','pelanggaranPage',
    'adminPage','lapBulananPage','auditPage','laporanAuditPage'
  ];

  list.forEach(sec=>{
    const el=document.getElementById(sec);
    if(!el) return;
    if(sec===id) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });
}
// ======= LOGIN / LOGOUT =======
function login(){
  const userId = document.getElementById('userSelect').value;
  const kode = document.getElementById('kode').value.trim();
  if(!userId) return alert('Pilih user.');
  const user = users.find(u => u.id === userId);
  if(!user) return alert('User tidak ditemukan.');
  if(kode !== user.code) return alert('Kode akses salah.');

  currentUser = user;
  document.getElementById('kode').value = '';
  document.getElementById('loginPage').classList.add('hidden');

  if(user.role === 'admin'){
    showSection('adminPage');
  } else {
    // naqib
    document.getElementById('naqibLabel').textContent = user.label;
    document.getElementById('naqibLabel2').textContent = user.label;
    populateSantriSelect(user.naqibName);
    openNaqibPage(user);
    showSection('absensiPage');
  }
}

function logout(){
  currentUser = null;
  document.getElementById('userSelect').value = '';
  document.getElementById('kode').value = '';
  document.getElementById('rekapArea').innerHTML = 'Silakan pilih rentang tanggal.';
  showSection('loginPage');
}


// ======= ABSENSI =======
function openNaqibPage(user){
  const list = dataSantri[user.naqibName] || [];
  const body = document.getElementById('santriTable');
  body.innerHTML = '';
  list.forEach(n=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${n}</td>
      <td><input type="radio" name="${escapeName(n)}" value="Hadir" checked></td>
      <td><input type="radio" name="${escapeName(n)}" value="Izin"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Sakit"></td>
      <td><input type="radio" name="${escapeName(n)}" value="Alfa"></td>`;
    body.appendChild(tr);
  });

  // set pelNaqib for pelanggaran form
  const pelNaqib = document.getElementById('pelNaqib');
  if(pelNaqib) pelNaqib.value = user.naqibName;
}

function escapeName(n){ return n.replace(/[^a-z0-9]/gi,'_'); }

function checkAll(){ document.querySelectorAll('input[value="Hadir"]').forEach(r=> r.checked=true); }

function simpan(){
  if(!currentUser || currentUser.role !== 'naqib') return alert('Hanya naqib dapat mengisi absensi.');
  const tanggal = document.getElementById('tanggal').value;
  const program = document.getElementById('program').value;
  const naqib = currentUser.naqibName;
  if(!tanggal) return alert('Pilih tanggal.');
  const rows = document.querySelectorAll('#santriTable tr');
  rows.forEach(row=>{
    const nama = row.children[0].innerText;
    const status = document.querySelector(`input[name="${escapeName(nama)}"]:checked`).value;
    if(typeof simpanOnline === 'function'){
      simpanOnline({ tanggal, program, naqib, nama, status });
    }
  });
  alert('Absensi tersimpan.');
}


// ======= PELANGGARAN =======
function populateSantriSelect(naqib){
  const el = document.getElementById('pelSantri');
  if(!el) return;
  el.innerHTML = '<option value="">-- Pilih Santri --</option>';
  (dataSantri[naqib] || []).forEach(s=>{
    const o = document.createElement('option');
    o.value = s; o.textContent = s;
    el.appendChild(o);
  });
  const pelNaqib = document.getElementById('pelNaqib');
  if(pelNaqib) pelNaqib.value = naqib;
}

function simpanPelanggaran(){
  if(!currentUser) return alert('Anda belum login.');
  const naqib = currentUser.naqibName;
  const nama = document.getElementById('pelSantri').value;
  const tanggal = document.getElementById('pelTanggal').value;
  const kategori = document.getElementById('pelKategori').value;
  const jenis = document.getElementById('pelJenis').value.trim();
  const level = document.getElementById('pelLevel').value;
  const catatan = document.getElementById('pelCatatan').value || '';
  if(!nama) return alert('Pilih nama.');
  if(!jenis) return alert('Isi jenis pelanggaran.');

  if(typeof loadAllPelanggaran !== 'function' || typeof simpanPelanggaranOnline !== 'function'){
    return alert('Fungsi penyimpanan pelanggaran belum tersedia (Firebase).');
  }

  loadAllPelanggaran(list=>{
    const dup = list.find(p => p.nama === nama && p.jenis === jenis && p.tanggal === tanggal);
    if(dup) return alert('Duplikasi: Pelanggaran sudah tercatat pada tanggal itu.');
    simpanPelanggaranOnline({ tanggal, naqib, nama, kategori, jenis, level, catatan });
    alert('Pelanggaran disimpan.');
    document.getElementById('pelJenis').value = '';
    document.getElementById('pelCatatan').value = '';
  });
}


// ======= REKAP / TAMPILAN =======
function rekapHarian(){
  loadFilteredRange(list=> renderRekapTable(list,'Rekap Harian'));
}

function rekapPekanan(){
  loadFilteredRange(list=> renderRekapTable(list,'Rekap Pekanan'));
}

function rekapBulanan(){
  loadFilteredRange(list=> renderRekapTable(list,'Rekap Bulanan'));
}

function tampilkanRekap(){
  loadFilteredRange(list=> renderRekapTable(list,'Semua Data'));
}

function tampilRekap(list, title){
  const area = document.getElementById('rekapArea');
  if(!list || !list.length){ area.innerHTML = "<b>Tidak ada data.</b>"; return; }
  let html = `<h4>${title}</h4><table><thead><tr><th>Tanggal</th><th>Program</th><th>Naqib</th><th>Santri</th><th>Status</th></tr></thead><tbody>`;
  list.forEach(r=>{
    html += `<tr><td>${r.tanggal}</td><td>${r.program||'-'}</td><td>${r.naqib||'-'}</td><td style="text-align:left">${r.nama}</td><td>${r.status||'-'}</td></tr>`;
  });
  html += "</tbody></table>";
  area.innerHTML = html;
}


// ======= DATE HELPERS & FILTER =======
function toISODate(d){ const _d = (d instanceof Date) ? d : new Date(d); const y=_d.getFullYear(); const m=String(_d.getMonth()+1).padStart(2,'0'); const day=String(_d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function parseISO(str){ const p=str.split('-'); return new Date(p[0],p[1]-1,p[2]); }

function loadFilteredRange(cb){
  if(!window.loadAllAbsensi) return cb([]);
  const from = parseISO(document.getElementById('fromDate').value);
  const to   = parseISO(document.getElementById('toDate').value);
  loadAllAbsensi(list=>{
    const f = list.filter(it=>{
      if(!it.tanggal) return false;
      const d = parseISO(it.tanggal);
      return d>=from && d<=to;
    });
    cb(f);
  });
}
// ===============================
//     LAPORAN BULANAN PER SANTRI
// ===============================

// Populate santri ketika naqib dipilih di laporan bulanan
document.addEventListener('DOMContentLoaded', ()=>{
  const bn = document.getElementById('bulananNaqib');
  if(bn){
    bn.addEventListener('change', function(){
      const naqib = this.value;
      const sel = document.getElementById('bulananSantri');
      sel.innerHTML = '<option value="">-- Pilih Santri --</option>';
      if(dataSantri[naqib]){
        dataSantri[naqib].forEach(n=>{
          const o=document.createElement('option');
          o.value=o.textContent=n;
          sel.appendChild(o);
        });
      }
    });
  }
});


// Hitung persentase dengan aturan: 
// - HANYA Hadir yang dihitung kelulusan
// - Izin & Sakit = tidak menurunkan persentase
function percent(x, total){
  if(total === 0) return "0%";
  return Math.round((x / total) * 100) + "%";
}

function namaBulan(b){
  return ["Januari","Februari","Maret","April","Mei","Juni","Juli",
          "Agustus","September","Oktober","November","Desember"][b];
}

function generateLaporanBulanan(){
  const naqib = document.getElementById('bulananNaqib').value;
  const santri = document.getElementById('bulananSantri').value;
  const bulan  = parseInt(document.getElementById('bulananBulan').value);
  const tahun  = parseInt(document.getElementById('bulananTahun').value);

  if(!naqib || !santri || isNaN(bulan)) 
    return alert('Lengkapi semua pilihan.');

  const from = new Date(tahun, bulan, 1);
  const to   = new Date(tahun, bulan+1, 0);

  if(typeof loadAllAbsensi !== 'function'){
    return alert('Firebase belum terhubung (absensi).');
  }

  loadAllAbsensi(absensi=>{
    if(typeof loadAllPelanggaran !== 'function'){
      return alert('Firebase belum terhubung (pelanggaran).');
    }

    loadAllPelanggaran(pelanggaran=>{
      const abs = absensi.filter(a =>
        a.naqib===naqib &&
        a.nama===santri &&
        parseISO(a.tanggal)>=from &&
        parseISO(a.tanggal)<=to
      );

      const pel = pelanggaran.filter(p =>
        p.naqib===naqib &&
        p.nama===santri &&
        parseISO(p.tanggal)>=from &&
        parseISO(p.tanggal)<=to
      );

      // generate tabel absensi
      const programs = [...new Set(abs.map(a=>a.program))];
      let tableAbsensi = "";

      programs.forEach((p,i)=>{
        const d = abs.filter(a=>a.program===p);
        const total = d.length;
        const hadir = d.filter(a=>a.status==="Hadir").length;
        const izin  = d.filter(a=>a.status==="Izin").length;
        const sakit = d.filter(a=>a.status==="Sakit").length;
        const alfa  = d.filter(a=>a.status==="Alfa").length;

        tableAbsensi += `
          <tr>
            <td>${i+1}</td>
            <td style="text-align:left">${p}</td>
            <td>${percent(hadir,total)}</td>
            <td>${percent(izin,total)}</td>
            <td>${percent(sakit,total)}</td>
            <td>${percent(alfa,total)}</td>
          </tr>
        `;
      });

      // generate tabel pelanggaran
      let tablePelanggaran = "";
      pel.forEach((p,i)=>{
        tablePelanggaran += `
          <tr>
            <td>${i+1}</td>
            <td>${p.tanggal}</td>
            <td>${p.jenis}</td>
            <td style="text-align:left">${p.catatan||''}</td>
          </tr>
        `;
      });

      // isi ke halaman
      document.getElementById('lapBulananHasil').innerHTML = `
        <div>
          <h2 style="margin:0">LAPORAN KEHADIRAN SANTRI</h2>
          <p>
            <b>Nama Santri:</b> ${santri}<br>
            <b>Naqib:</b> ${naqib}<br>
            <b>Bulan:</b> ${namaBulan(bulan)} ${tahun}
          </p>

          <h3>Persentase Kehadiran</h3>
          <table>
            <thead>
              <tr>
                <th>No</th><th>Program</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th>
              </tr>
            </thead>
            <tbody>
              ${tableAbsensi || '<tr><td colspan="6">Tidak ada data</td></tr>'}
            </tbody>
          </table>

          <h3 style="margin-top:16px">Laporan Pelanggaran</h3>
          <table>
            <thead>
              <tr><th>No</th><th>Tanggal</th><th>Pelanggaran</th><th>Catatan</th></tr>
            </thead>
            <tbody>
              ${tablePelanggaran || '<tr><td colspan="4">Tidak ada data</td></tr>'}
            </tbody>
          </table>
        </div>
      `;

      // simpan untuk export
      window._lastMonthlyReportHTML = document.getElementById('lapBulananHasil').innerHTML;
    });
  });
}


// ========================================================
//                EXPORT PDF (Laporan Bulanan)
// ========================================================
function exportLaporanBulananPDF(){
  const area = document.getElementById('lapBulananHasil');
  if(!area.innerText.trim()) return alert('Tampilkan laporan dulu.');

  const santri = document.getElementById('bulananSantri').value;
  const bulan  = parseInt(document.getElementById('bulananBulan').value);
  const tahun  = document.getElementById('bulananTahun').value;
  const fileName = `${santri}_${namaBulan(bulan)}_${tahun}.pdf`;

  if(!window.jspdf) return alert('jsPDF belum dimuat.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  doc.setFontSize(14);

  doc.text(`Laporan Bulanan Santri — ${santri}`, 40, 40);
  let y = 70;

  const tables = area.querySelectorAll('table');
  tables.forEach(tbl=>{
    const head = [];
    tbl.querySelectorAll('thead tr th').forEach(th=> head.push(th.innerText));

    const body = [];
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const row = [];
      tr.querySelectorAll('td').forEach(td=> row.push(td.innerText));
      body.push(row);
    });

    doc.autoTable({
      head:[head],
      body,
      startY:y,
      theme:'grid',
      margin:{left:40,right:40},
      styles:{fontSize:9}
    });

    y = doc.lastAutoTable.finalY + 20;
  });

  doc.save(fileName);
}


// ========================================================
//            REKAP PELANGGARAN (Admin)
// ========================================================
function filterByDateRange(items){
  const fromEl=document.getElementById('fromDate');
  const toEl=document.getElementById('toDate');
  if(!fromEl || !toEl) return items;

  const from=parseISO(fromEl.value);
  const to=parseISO(toEl.value);

  return items.filter(it=>{
    if(!it.tanggal) return false;
    const d=parseISO(it.tanggal);
    return d>=from && d<=to;
  });
}

function rekapPelanggaranAll(){
  loadAllPelanggaran(list=>{
    list = filterByDateRange(list);
    tampilRekapPelanggaran("Semua Pelanggaran", list);
  });
}

function rekapPelanggaranBaru(){
  loadAllPelanggaran(list=>{
    list = filterByDateRange(list);
    const f = list.filter(p=> p.kategori==="Baru");
    tampilRekapPelanggaran("Pelanggaran Baru", f);
  });
}

function rekapPelanggaranBerulang(){
  loadAllPelanggaran(list=>{
    list = filterByDateRange(list);
    const f = list.filter(p=> p.kategori==="Berulang");
    tampilRekapPelanggaran("Pelanggaran Berulang", f);
  });
}

function tampilRekapPelanggaran(title, list){
  const area = document.getElementById('rekapArea');
  if(!list.length){
    area.innerHTML = "<b>Tidak ada data pelanggaran dalam rentang ini.</b>";
    return;
  }

  list.sort((a,b)=> a.tanggal.localeCompare(b.tanggal));

  let html = `
    <h3>${title}</h3>
    <h4>Statistik</h4>
    <table>
      <tr><th>Total</th><td>${list.length}</td></tr>
    </table>

    <h4>Histori</h4>
    <table>
      <thead>
        <tr>
          <th>Tanggal</th><th>Naqib</th><th>Santri</th>
          <th>Kategori</th><th>Jenis</th><th>Level</th><th>Catatan</th>
        </tr>
      </thead>
      <tbody>
  `;

  list.forEach(p=>{
    html+=`
      <tr>
        <td>${p.tanggal}</td>
        <td>${p.naqib}</td>
        <td>${p.nama}</td>
        <td>${p.kategori}</td>
        <td>${p.jenis}</td>
        <td>${p.level}</td>
        <td>${p.catatan}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  area.innerHTML = html;
}
// =========================
// AUDIT KEBERSIHAN (LOGIC)
// =========================

// Inisialisasi dropdown audit dan tanggal default
function initAuditDropdown(){
  const sel = document.getElementById('auditNaqib');
  if(!sel) return;
  sel.innerHTML = '<option value="">-- Pilih Naqib --</option>';
  Object.keys(dataSantri).forEach(nq=>{
    const o = document.createElement('option'); o.value = nq; o.textContent = nq;
    sel.appendChild(o);
  });
  const t = document.getElementById('auditTanggal');
  if(t) t.value = toISODate(new Date());
  updateAuditTotal();
}

// Hitung total audit dari 5 field
function updateAuditTotal(){
  const ids = ['auditLantai','auditTempatTidur','auditLemari','auditKamarMandi','auditArea'];
  let sum = 0;
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      const v = Number(el.value || 0);
      sum += v;
    }
  });
  const out = document.getElementById('auditTotal');
  if(out) out.textContent = sum;
}

// Input listener khusus audit (agar tidak bentrok)
document.addEventListener('input', function(e){
  if(!e.target) return;
  const id = e.target.id || '';
  if(['auditLantai','auditTempatTidur','auditLemari','auditKamarMandi','auditArea'].includes(id)){
    // clamp values 0..20
    let v = Number(e.target.value || 0);
    if(v < 0) v = 0;
    if(v > 20) v = 20;
    e.target.value = v;
    updateAuditTotal();
  }
});

// Simpan audit (memanggil simpanAuditOnline yang harus ada di module Firebase)
function simpanAudit() {
    const supervisor = document.getElementById("auditSupervisor").value;
    const naqib = document.getElementById("auditNaqib").value;
    const tanggal = document.getElementById("auditTanggal").value;
    const skor = Number(document.getElementById("auditTotal").textContent);
    const catatan = document.getElementById("auditCatatan").value || "-";

    if (!supervisor || !naqib || !tanggal) {
        alert("Lengkapi Supervisor, Naqib, dan Tanggal!");
        return;
    }

    const entry = {
        tanggal,
        supervisor,
        naqib,
        skor,
        catatan
    };

    window.simpanAuditOnline(entry);
    alert("Audit berhasil disimpan!");
}



// ===================================================
// CEK KPI (integrasi audit) & render KPI
// ===================================================

function cekKPI(){
  // Ambil rentang tanggal (gunakan fromDate/toDate)
  const fromEl = document.getElementById('fromDate');
  const toEl = document.getElementById('toDate');
  if(!fromEl || !toEl) return alert('Masukkan rentang tanggal pada panel Admin.');

  const from = parseISO(fromEl.value);
  const to   = parseISO(toEl.value);

  if(typeof loadAllAbsensi !== 'function' || typeof loadAllPelanggaran !== 'function' || typeof loadAuditByMonth !== 'function'){
    return alert('Fungsi Firebase (absensi/pelanggaran/audit) belum tersedia.');
  }

  loadAllAbsensi(allAbsensi=>{
    loadAllPelanggaran(allPelanggaran=>{
      const naqibs = Object.keys(dataSantri);

      // initialize stats
      const stats = {};
      naqibs.forEach(nq=>{
        stats[nq] = {Hadir:0,Alfa:0,TotalAbsensi:0,PelanggaranBaru:0,PelanggaranBerulang:0, Audit:0};
      });

      // filter dan hitung absensi
      const abs = allAbsensi.filter(a=>{
        if(!a.tanggal) return false;
        const d = parseISO(a.tanggal);
        return d >= from && d <= to;
      });

      abs.forEach(a=>{
        if(!stats[a.naqib]) return;
        stats[a.naqib].TotalAbsensi++;
        if(a.status === 'Hadir') stats[a.naqib].Hadir++;
        if(a.status === 'Alfa') stats[a.naqib].Alfa++;
        // izin & sakit tidak mempengaruhi perhitungan persen
      });

      // filter dan hitung pelanggaran
      const pel = allPelanggaran.filter(p=>{
        if(!p.tanggal) return false;
        const d = parseISO(p.tanggal);
        return d >= from && d <= to;
      });

      pel.forEach(p=>{
        if(!stats[p.naqib]) return;
        if(p.kategori === 'Baru') stats[p.naqib].PelanggaranBaru++;
        if(p.kategori === 'Berulang') stats[p.naqib].PelanggaranBerulang++;
      });

      // sekarang load audit per naqib (bulan berdasarkan from)
      const month = from.getMonth();
      const year  = from.getFullYear();

      let pending = naqibs.length;
      naqibs.forEach(nq=>{
        // default 0
        stats[nq].Audit = 0;
        loadAuditByMonth(nq, month, year, audits=>{
          if(Array.isArray(audits) && audits.length){
            // rata-rata total audit untuk bulan itu
            const sum = audits.reduce((acc, x)=> acc + (Number(x.total) || 0), 0);
            stats[nq].Audit = Math.round(sum / audits.length);
          } else {
            stats[nq].Audit = 0;
          }
          pending--;
          if(pending === 0){
            // semua data siap -> render
            renderKPI(stats);
          }
        });
      });

    });
  });
}


// RENDER KPI ke area rekapArea
function renderKPI(stats){
  let html = `<h3>CEK KPI Naqib</h3>
    <table>
      <thead>
        <tr>
          <th>Naqib</th>
          <th>% Kehadiran</th>
          <th>Pelanggaran Baru</th>
          <th>Pelanggaran Berulang</th>
          <th>Skor Audit</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
  `;

  Object.keys(stats).forEach(nq=>{
    const s = stats[nq];
    const hadirPct = s.TotalAbsensi === 0 ? 0 : Math.round((s.Hadir / s.TotalAbsensi) * 100);
    const okHadir = hadirPct >= 90;
    const okBaru = s.PelanggaranBaru <= 15;
    const okUlang = s.PelanggaranBerulang <= 5;
    const okAudit = s.Audit >= 85;

    const statusText = (okHadir && okBaru && okUlang && okAudit) ? 'TERCAPAI' : 'TIDAK TERCAPAI';
    const statusColor = (okHadir && okBaru && okUlang && okAudit) ? 'green' : 'red';

    html += `<tr>
      <td style="text-align:left">${nq}</td>
      <td>${hadirPct}%</td>
      <td>${s.PelanggaranBaru}</td>
      <td>${s.PelanggaranBerulang}</td>
      <td>${s.Audit}</td>
      <td style="color:${statusColor};font-weight:bold">${statusText}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('rekapArea').innerHTML = html;
}


// initialize audit controls when DOM ready (also init() already runs earlier)
document.addEventListener('DOMContentLoaded', function(){
  try{ initAuditDropdown(); }catch(e){}
});

</script>

<!-- FUNGSI REKAP FORMAT BARU -->
<script>
function renderRekapTable(absensiList, title){
  const area = document.getElementById('rekapArea');
  if(!absensiList.length){
    area.innerHTML = "<b>Tidak ada data dalam rentang ini.</b>";
    return;
  }

  const programs = [
    "TAHAJJUD","SHALAT SUBUH","JOGING PAGI","SHALAT ZUHUR","TIDUR SIANG",
    "SHALAT ASHAR","SHALAT MAGHRIB","SHALAT ISYA","TIDUR MALAM","PIKET KEBERSIHAN"
  ];

  const naqibs = Object.keys(dataSantri);
  const map = {};

  programs.forEach(p=>{
    map[p] = {};
    naqibs.forEach(nq=>{
      map[p][nq] = {hadir:0,total:0};
    });
  });

  absensiList.forEach(a=>{
    if(map[a.program] && map[a.program][a.naqib]){
      map[a.program][a.naqib].total++;
      if(a.status==="Hadir") map[a.program][a.naqib].hadir++;
    }
  });

  let html = `
    <h3>${title}</h3>
    <table>
      <thead>
        <tr>
          <th>Program</th>
          ${naqibs.map(n=>`<th>${n}</th>`).join('')}
          <th>Total Program (%)</th>
        </tr>
      </thead>
      <tbody>
  `;

  programs.forEach(p=>{
    html += `<tr><td style="text-align:left">${p}</td>`;
    let sumPct = 0;

    naqibs.forEach(nq=>{
      const t = map[p][nq].total;
      const h = map[p][nq].hadir;
      const pct = t===0 ? 0 : Math.round((h/t)*100);
      sumPct += pct;
      html += `<td>${pct}%</td>`;
    });

    html += `<td><b>${Math.round(sumPct/naqibs.length)}%</b></td></tr>`;
  });

  html += `<tr><th>Total per Naqib (%)</th>`;
  naqibs.forEach(nq=>{
    let h=0, t=0;
    absensiList.forEach(a=>{
      if(a.naqib===nq){
        t++;
        if(a.status==="Hadir") h++;
      }
    });
    const pct = t===0 ? 0 : Math.round((h/t)*100);
    html += `<td><b>${pct}%</b></td>`;
  });

  html += `<td></td></tr></tbody></table>`;
  area.innerHTML = html;
}
</script>

<!-- =============== LAPORAN AUDIT KEBERSIHAN (BENAR) =============== -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const sel = document.getElementById("lapAuditNaqib");
  if(sel){
    Object.keys(dataSantri).forEach(n=>{
      const o = document.createElement("option");
      o.value = n;
      o.textContent = n;
      sel.appendChild(o);
    });
  }
});

function loadLaporanAudit(){
  const from = document.getElementById("auditFrom").value;
  const to = document.getElementById("auditTo").value;
  const filterNaqib = document.getElementById("lapAuditNaqib").value;
  const area = document.getElementById("hasilAuditList");

  if(!from || !to){
    area.innerHTML = "<b>Pilih tanggal terlebih dahulu.</b>";
    return;
  }

  if(!window.auditList){
    area.innerHTML = "Data audit belum dimuat.";
    return;
  }

  let list = window.auditList.filter(a=>{
    return a.tanggal >= from && a.tanggal <= to;
  });

  if(filterNaqib){
    list = list.filter(a=> a.naqib === filterNaqib);
  }

  if(list.length === 0){
    area.innerHTML = "<b>Tidak ada audit pada rentang ini.</b>";
    return;
  }

  let html = `
    <h4>Hasil Audit</h4>
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Naqib</th>
          <th>Supervisor</th>
          <th>Skor</th>
          <th>Catatan</th>
        </tr>
      </thead>
      <tbody>
  `;

  list.forEach(a=>{
    const warna =
      a.skor >= 85 ? "green" :
      a.skor >= 70 ? "orange" : "red";

    html += `
      <tr>
        <td>${a.tanggal}</td>
        <td>${a.naqib}</td>
        <td>${a.supervisor}</td>
        <td style="font-weight:bold; color:${warna}">${a.skor}</td>
        <td>${a.catatan || "-"}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  area.innerHTML = html;
}
</script>
<!-- FIREBASE MODULE -->
<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

  import { 
    getDatabase, ref, push, onValue, remove, get, query, orderByChild, equalTo
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0Ez2a85ZwQLR28U-yHpVmM3o8NMxZoLI",
    authDomain: "absensi-santri-fajrul-islam.firebaseapp.com",
    databaseURL: "https://absensi-santri-fajrul-islam-default-rtdb.firebaseio.com",
    projectId: "absensi-santri-fajrul-islam",
    storageBucket: "absensi-santri-fajrul-islam.appspot.com",
    messagingSenderId: "739928369926",
    appId: "1:739928369926:web:7e95375c3ddba0f584cdd07"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // =========================
  //        ABSENSI
  // =========================
  window.simpanOnline = function(entry){
    try{
      push(ref(db, 'absensi'), entry);
    } catch(e){
      console.error(e);
      alert('Gagal simpan absensi: ' + (e.message || e));
    }
  };

  window.loadAllAbsensi = function(callback){
    const r = ref(db, 'absensi');
    onValue(r, snapshot=>{
      const data = snapshot.val() || {};
      const arr = Object.keys(data).map(k => data[k]);
      callback(arr);
    }, err=>{
      console.error(err);
      callback([]);
    });
  };


  // =========================
  //       PELANGGARAN
  // =========================
  window.simpanPelanggaranOnline = function(entry){
    try{
      push(ref(db, 'pelanggaran'), entry);
    } catch(e){
      console.error(e);
      alert('Gagal simpan pelanggaran: ' + (e.message || e));
    }
  };

  window.loadAllPelanggaran = function(callback){
    const r = ref(db, 'pelanggaran');
    onValue(r, snapshot=>{
      const data = snapshot.val() || {};
      const arr = Object.keys(data).map(k => data[k]);
      callback(arr);
    }, err=>{
      console.error(err);
      callback([]);
    });
  };

  window._firebaseRemovePelanggaran = function(){
    return remove(ref(db,'pelanggaran'));
  };
// =======================
//   AUDIT KEBERSIHAN
// =======================
const auditRef = ref(db, "auditKebersihan");

onValue(auditRef, snap => {
    const data = snap.val();
    if (!data) {
        window.auditList = [];
        console.log("Audit kosong");
        return;
    }

    window.auditList = Object.values(data);
    console.log("Audit loaded:", window.auditList);
});


  // =========================
  //      AUDIT KEBERSIHAN
  // =========================
  window.simpanAuditOnline = function(entry){
    try{
      push(ref(db, 'auditKebersihan'), entry);
    } catch(e){
      console.error(e);
      alert('Gagal simpan audit: ' + (e.message || e));
    }
  };

  // Load audit by Naqib and Month
  window.loadAuditByMonth = function(naqib, month, year, callback){
    const r = ref(db, 'auditKebersihan');

    onValue(r, snapshot=>{
      const data = snapshot.val() || {};
      const arr = Object.keys(data).map(k => data[k]);

      const filtered = arr.filter(a=>{
        if(a.naqib !== naqib) return false;
        if(!a.tanggal) return false;
        const d = new Date(a.tanggal);
        return d.getMonth() === month && d.getFullYear() === year;
      });

      callback(filtered);
    });
  };

  console.log("Firebase module loaded successfully.");
</script>
